<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial OS v16 (Autofill & Stability)</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        .progress-bar { transition: width 0.5s ease-in-out; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .chart-segment { transition: stroke-width 0.2s; cursor: pointer; }
        .chart-segment:hover { stroke-width: 25; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 text-slate-800 font-sans">
    <div id="root"></div>
    
    <script type="text/babel">
        // --- FIREBASE CONFIGURATION ---
        // PASTE YOUR KEYS HERE
        const firebaseConfig = {
            apiKey: "AIzaSyDRIcg7GW08eoTAmpd_kUKfDirSg3LsDTE",
    	    authDomain: "pfpt-budget-tracker.firebaseapp.com",
            projectId: "pfpt-budget-tracker",
            storageBucket: "pfpt-budget-tracker.firebasestorage.app",
            messagingSenderId: "431901940294",
            appId: "1:431901940294:web:0be497e4b7662165334847"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        const { useState, useEffect, useRef, useMemo } = React;

        // --- ICONS ---
        const Icons = {
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
            ChevronDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>,
            ChevronUp: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>,
            Calendar: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
            Chart: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>,
            LogOut: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>,
            Filter: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>,
            Bolt: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
        };

        const MONTHS = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const COLORS = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6', '#f97316', '#64748b'];

        // Helper: IDs
        const generateId = (name) => name.toLowerCase().replace(/[^a-z0-9]/g, '') + '_' + Date.now();
        const getEmptyYear = () => {
            const y = {};
            for (let i = 0; i < 12; i++) y[i] = { income: [], expenses: {}, spent: {}, transactions: {}, debts: {} };
            return y;
        };

        // Default Data
        const DEFAULT_DATA = {
            categories: {
                fixed: [{ id: 'rent', label: 'Rent' }, { id: 'internet', label: 'Internet' }],
                variable: [{ id: 'groceries', label: 'Groceries' }, { id: 'gas', label: 'Gas' }],
                savings: [{ id: 'roth', label: 'Roth IRA' }]
            },
            assets: [], debts: [], savingsGoals: [],
            years: { [new Date().getFullYear()]: getEmptyYear() }
        };

        // --- SHARED COMPONENT ---
        const SummaryBlock = ({ stats, title, colorClass = "bg-slate-900" }) => (
            <div className={`${colorClass} text-white p-6 rounded-xl mt-4 shadow-lg border border-slate-700`}>
                <h3 className="font-bold text-slate-200 border-b border-slate-600 pb-2 mb-4 text-lg">{title}</h3>
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-6 text-center">
                    <div><p className="text-xs text-slate-400 uppercase tracking-wider">Total Income</p><p className="text-xl font-bold text-green-400">${stats.income.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p></div>
                    <div><p className="text-xs text-slate-400 uppercase tracking-wider">Total Budgeted</p><p className="text-xl font-bold text-blue-400">${stats.budgeted.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p></div>
                    <div><p className="text-xs text-slate-400 uppercase tracking-wider">Total Spent</p><p className="text-xl font-bold text-red-400">${stats.spent.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p></div>
                    <div><p className="text-xs text-slate-400 uppercase tracking-wider">Remaining Cash</p><p className={`text-xl font-bold ${stats.remaining>=0?'text-green-400':'text-red-400'}`}>${stats.remaining.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p></div>
                    <div><p className="text-xs text-slate-400 uppercase tracking-wider">Proj. Savings</p><p className="text-xl font-bold text-purple-400">${stats.saved.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p></div>
                    <div><p className="text-xs text-slate-400 uppercase tracking-wider">Savings Rate</p><p className="text-xl font-bold text-purple-400">{stats.rate}%</p></div>
                </div>
            </div>
        );

        const FinancialOS = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [data, setData] = useState(null);
            const [activeTab, setActiveTab] = useState('budget');
            
            // UI States
            const [expandedYears, setExpandedYears] = useState([new Date().getFullYear().toString()]);
            const [expandedMonths, setExpandedMonths] = useState({});
            const [activeTransactionCategory, setActiveTransactionCategory] = useState(null);
            const [analyticsYear, setAnalyticsYear] = useState('All Time');
            const [analyticsMonth, setAnalyticsMonth] = useState('Whole Year');

            const [inputs, setInputs] = useState({ year: '', cat: '', itemDesc: '', itemAmt: '', assetName: '', assetVal: '', debtName: '', debtBal: '', debtRate: '', goalName: '', goalTarget: '', incName: '', incAmt: '', varCat: '', saveCat: '' });
            const [debtSimExtra, setDebtSimExtra] = useState(0);

            // --- AUTH & SYNC (FIXED WHITE SCREEN) ---
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(u => {
                    if (u) {
                        setUser(u);
                        // Loading remains true until data snapshot fires
                    } else {
                        setUser(null);
                        setData(null);
                        setLoading(false);
                    }
                });
                return unsubscribe;
            }, []);

            useEffect(() => {
                if (user) {
                    setLoading(true);
                    const docRef = db.collection('users').doc(user.uid);
                    const unsubscribe = docRef.onSnapshot(doc => {
                        if (doc.exists) {
                            setData(doc.data());
                        } else {
                            docRef.set(DEFAULT_DATA);
                            setData(DEFAULT_DATA);
                        }
                        setLoading(false); // Data is ready
                    }, (err) => {
                        console.error(err);
                        setLoading(false); // Stop loading even if error, so we don't get stuck
                    });
                    return unsubscribe;
                }
            }, [user]);

            // Auto-Save
            useEffect(() => {
                if (user && data && !loading) {
                    const timer = setTimeout(() => {
                        db.collection('users').doc(user.uid).set(data);
                    }, 1000);
                    return () => clearTimeout(timer);
                }
            }, [data, user, loading]);

            const login = () => auth.signInWithPopup(googleProvider).catch(e => alert(e.message));
            const logout = () => {
                auth.signOut();
                setUser(null);
                setData(null); 
            };

            // --- CALCS ---
            const getCatSpent = (m, catId) => m.transactions?.[catId]?.reduce((s, t) => s + t.amount, 0) || 0;
            const getMonthIncome = (m) => m.income.reduce((s, i) => s + i.amount, 0);

            const calculateStats = (monthsArray) => {
                if (!data) return { income: 0, budgeted: 0, spent: 0, saved: 0, debtPaid: 0, remaining: 0, rate: 0 };
                let s = { income: 0, budgeted: 0, spent: 0, saved: 0, debtPaid: 0 };
                
                monthsArray.forEach(m => {
                    s.income += getMonthIncome(m);
                    data.categories.fixed.forEach(c => {
                        s.budgeted += (m.expenses[c.id] || 0);
                        s.spent += (m.spent[c.id] || 0);
                    });
                    data.categories.variable.forEach(c => {
                        s.budgeted += (m.expenses[c.id] || 0);
                        s.spent += getCatSpent(m, c.id);
                    });
                    data.categories.savings.forEach(c => {
                        s.budgeted += (m.expenses[c.id] || 0);
                        s.saved += (m.spent[c.id] || 0); 
                    });
                    data.debts.forEach(d => {
                        s.debtPaid += (m.debts?.[d.id]?.payment || 0);
                        s.spent += (m.debts?.[d.id]?.payment || 0);
                    });
                });
                s.remaining = s.income - (s.spent + s.saved);
                s.rate = s.income > 0 ? ((s.saved / s.income) * 100).toFixed(1) : "0.0";
                return s;
            };

            // --- ACTIONS ---
            const updateMonth = (y, mIdx, cb) => setData(d => ({ ...d, years: { ...d.years, [y]: { ...d.years[y], [mIdx]: cb(d.years[y][mIdx]) } } }));
            const addCategory = (type, name) => {
                if(!name) return;
                const id = generateId(name);
                setData(d => ({...d, categories: {...d.categories, [type]: [...(d.categories[type]||[]), {id, label: name}]}}));
                if(type === 'fixed') setInputs(prev => ({...prev, cat: ''}));
                if(type === 'variable') setInputs(prev => ({...prev, varCat: ''}));
                if(type === 'savings') setInputs(prev => ({...prev, saveCat: ''}));
            };
            const deleteCategory = (type, id) => {
                if(confirm("Delete category?")) setData(d => ({...d, categories: {...d.categories, [type]: d.categories[type].filter(c => c.id !== id)}}));
            };
            const deleteYear = (year) => {
                if(confirm(`Delete ${year}?`)) {
                    setData(d => { const newYears = { ...d.years }; delete newYears[year]; return { ...d, years: newYears }; });
                }
            };

            // NEW: AUTOFILL FUNCTION
            const autofillBudget = (year, sourceMonthIdx) => {
                if(!confirm(`Copy budget values from ${MONTHS[sourceMonthIdx]} to ALL other months in ${year}? Existing spent/income values will remain.`)) return;
                
                const sourceExpenses = data.years[year][sourceMonthIdx].expenses;
                
                setData(d => {
                    const updatedYear = { ...d.years[year] };
                    for (let i = 0; i < 12; i++) {
                        if (i !== sourceMonthIdx) {
                            // Keep existing transactions/spent, only overwrite budget targets (expenses)
                            updatedYear[i] = {
                                ...updatedYear[i],
                                expenses: { ...sourceExpenses } // Copy the budget numbers
                            };
                        }
                    }
                    return { ...d, years: { ...d.years, [year]: updatedYear } };
                });
            };

            // --- VIEWS ---
            if (loading) return <div className="h-screen flex items-center justify-center bg-gray-100 flex-col"><div className="loader mb-4"></div><p className="text-slate-500 font-bold animate-pulse">Syncing Data...</p></div>;

            // CRITICAL GUARD: Ensure data exists before rendering main app
            if (user && !data) return <div className="h-screen flex items-center justify-center bg-gray-100 flex-col"><div className="loader mb-4"></div><p className="text-slate-500 font-bold animate-pulse">Loading Profile...</p></div>;

            if (!user) {
                return (
                    <div className="h-screen flex flex-col items-center justify-center bg-gray-100 p-4">
                        <div className="bg-white p-8 rounded-xl shadow-lg max-w-md w-full text-center">
                            <h1 className="text-3xl font-extrabold text-slate-800 mb-2">Financial OS</h1>
                            <p className="text-gray-500 mb-8">Secure, Multi-Year Budget Tracking</p>
                            <button onClick={login} className="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg w-full hover:bg-blue-700 transition flex items-center justify-center gap-2">
                                <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12.545 10.239v3.821h5.445c-0.712 2.315-2.647 3.972-5.445 3.972-3.332 0-6.033-2.531-6.033-5.652s2.701-5.652 6.033-5.652c1.498 0 2.866 0.549 3.921 1.453l2.814-2.814c-1.79-1.677-4.184-2.702-6.735-2.702-5.522 0-10 4.478-10 10s4.478 10 10 10c8.396 0 10.249-7.85 9.426-11.748l-9.426-0.001z"/></svg>
                                Sign In with Google
                            </button>
                        </div>
                    </div>
                );
            }

            const renderBudget = () => {
                return (
                    <div className="space-y-6">
                        {Object.keys(data.years).sort().map(year => {
                            const yearStats = calculateStats(Object.values(data.years[year]));
                            return (
                                <div key={year} className="border rounded-xl bg-white shadow-sm overflow-hidden">
                                    <div onClick={() => setExpandedYears(prev => prev.includes(year) ? prev.filter(y=>y!==year) : [...prev, year])} 
                                         className="bg-slate-800 text-white p-4 flex justify-between items-center cursor-pointer hover:bg-slate-700">
                                        <div className="flex items-center gap-4">
                                            <h2 className="text-xl font-bold flex gap-2"><Icons.Calendar/> {year}</h2>
                                            <button onClick={(e) => { e.stopPropagation(); deleteYear(year); }} className="text-slate-400 hover:text-red-400 p-1"><Icons.Trash /></button>
                                        </div>
                                        {expandedYears.includes(year) ? <Icons.ChevronUp/> : <Icons.ChevronDown/>}
                                    </div>
                                    {expandedYears.includes(year) && (
                                        <div className="p-4 grid gap-4">
                                            {MONTHS.map((monthName, mIdx) => {
                                                const mData = data.years[year][mIdx];
                                                const isExpanded = (expandedMonths[year] || []).includes(mIdx);
                                                const mStats = calculateStats([mData]);

                                                return (
                                                    <div key={mIdx} className={`border rounded-lg ${isExpanded ? 'ring-2 ring-blue-100' : ''}`}>
                                                        <div onClick={() => setExpandedMonths(prev => ({...prev, [year]: prev[year]?.includes(mIdx) ? prev[year].filter(m=>m!==mIdx) : [...(prev[year]||[]), mIdx]}))}
                                                             className="p-3 flex justify-between items-center bg-gray-50 cursor-pointer hover:bg-gray-100">
                                                            <span className="font-bold text-gray-700 w-24">{monthName}</span>
                                                            <div className="flex gap-4 text-sm text-gray-500 hidden md:flex">
                                                                <span>In: <b className="text-green-600">${mStats.income.toFixed(0)}</b></span>
                                                                <span>Out: <b className="text-red-600">${mStats.spent.toFixed(0)}</b></span>
                                                                <span>Rem: <b className={mStats.remaining >= 0 ? 'text-green-600' : 'text-red-600'}>${mStats.remaining.toFixed(0)}</b></span>
                                                            </div>
                                                            {isExpanded ? <Icons.ChevronUp/> : <Icons.ChevronDown/>}
                                                        </div>

                                                        {isExpanded && (
                                                            <div className="p-4 bg-white">
                                                                <div className="flex justify-end mb-4">
                                                                    <button onClick={()=>autofillBudget(year, mIdx)} className="text-xs flex items-center gap-1 bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 transition">
                                                                        <Icons.Bolt/> Apply to All Months
                                                                    </button>
                                                                </div>
                                                                <div className="grid lg:grid-cols-2 gap-6 mb-6">
                                                                    <div className="space-y-6">
                                                                        <div className="bg-green-50 p-3 rounded border border-green-100">
                                                                            <h4 className="text-xs font-bold text-green-800 uppercase mb-2">Income Sources</h4>
                                                                            {mData.income.map((inc, idx) => (
                                                                                <div key={idx} className="flex justify-between text-sm mb-1">
                                                                                    <span>{inc.label}</span>
                                                                                    <span className="font-mono">${inc.amount}</span>
                                                                                    <button onClick={()=>updateMonth(year, mIdx, m => ({...m, income: m.income.filter((_,i)=>i!==idx)}))} className="text-red-400"><Icons.Trash/></button>
                                                                                </div>
                                                                            ))}
                                                                            <div className="flex gap-1 mt-2">
                                                                                <input placeholder="Source" className="w-full text-xs border rounded px-1" value={inputs.incName} onChange={e=>setInputs({...inputs, incName: e.target.value})} />
                                                                                <input placeholder="$" type="number" className="w-16 text-xs border rounded px-1" value={inputs.incAmt} onChange={e=>setInputs({...inputs, incAmt: e.target.value})} />
                                                                                <button onClick={()=>{
                                                                                    if(inputs.incName && inputs.incAmt) {
                                                                                        updateMonth(year, mIdx, m => ({...m, income: [...m.income, {label: inputs.incName, amount: parseFloat(inputs.incAmt)}]}));
                                                                                        setInputs({...inputs, incName: '', incAmt: ''});
                                                                                    }
                                                                                }} className="bg-green-600 text-white rounded px-1"><Icons.Plus/></button>
                                                                            </div>
                                                                        </div>

                                                                        <div>
                                                                            <h4 className="font-bold text-sm text-gray-600 border-b mb-2">Fixed Expenses</h4>
                                                                            <div className="space-y-1">
                                                                                {data.categories.fixed.map(c => (
                                                                                    <div key={c.id} className="flex justify-between items-center text-xs">
                                                                                        <span className="flex items-center gap-1 group">{c.label} <button onClick={()=>deleteCategory('fixed', c.id)} className="opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-400"><Icons.Trash/></button></span>
                                                                                        <div className="flex gap-1">
                                                                                            <input type="number" className="w-16 border rounded px-1" value={mData.expenses[c.id]||''} placeholder="Bud" onChange={e=>updateMonth(year, mIdx, m => ({...m, expenses: {...m.expenses, [c.id]: parseFloat(e.target.value)||0}}))} />
                                                                                            <input type="number" className="w-16 border rounded px-1" value={mData.spent[c.id]||''} placeholder="Pay" onChange={e=>updateMonth(year, mIdx, m => ({...m, spent: {...m.spent, [c.id]: parseFloat(e.target.value)||0}}))} />
                                                                                        </div>
                                                                                    </div>
                                                                                ))}
                                                                                <div className="pt-2 flex gap-1">
                                                                                     <input placeholder="New Fixed Cat" className="w-full text-xs border rounded px-1" value={inputs.cat} onChange={e=>setInputs({...inputs, cat:e.target.value})}/>
                                                                                     <button onClick={()=>addCategory('fixed', inputs.cat)} className="bg-gray-200 rounded px-2"><Icons.Plus/></button>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>

                                                                    <div className="space-y-6">
                                                                        <div className="bg-purple-50 p-3 rounded border border-purple-100">
                                                                            <h4 className="text-xs font-bold text-purple-800 uppercase mb-2">Savings & Investments</h4>
                                                                            <div className="space-y-1">
                                                                                {data.categories.savings?.map(c => (
                                                                                    <div key={c.id} className="flex justify-between
