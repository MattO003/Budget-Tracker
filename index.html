<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial OS v21 (Customizable)</title>
    
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            alert("Error: " + message + "\nLine: " + lineno);
        };
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        .progress-bar { transition: width 0.5s ease-in-out; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .chart-segment { transition: stroke-width 0.2s; cursor: pointer; }
        .chart-segment:hover { stroke-width: 25; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
        .blur-val { filter: blur(5px); transition: filter 0.2s; user-select: none; }
        .blur-val:hover { filter: blur(0); }
    </style>
</head>
<body class="font-sans transition-colors duration-300">
    <div id="root"></div>
    
    <script type="text/babel">
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDRIcg7GW08eoTAmpd_kUKfDirSg3LsDTE",
            authDomain: "pfpt-budget-tracker.firebaseapp.com",
            projectId: "pfpt-budget-tracker",
            storageBucket: "pfpt-budget-tracker.firebasestorage.app",
            messagingSenderId: "431901940294",
            appId: "1:431901940294:web:0be497e4b7662165334847"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        const { useState, useEffect, useRef, useMemo } = React;

        // --- ICONS ---
        const Icons = {
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
            ChevronDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>,
            ChevronUp: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>,
            Calendar: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
            Chart: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>,
            LogOut: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>,
            Filter: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>,
            Bolt: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>,
            History: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
            Copy: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Eye: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>,
            EyeOff: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>,
            Gear: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        };

        // --- THEMES ---
        const THEMES = {
            ocean: { label: 'Ocean', bgHeader: 'bg-slate-800', bgPrimary: 'bg-blue-600', textPrimary: 'text-blue-600', bgLight: 'bg-blue-50', border: 'border-blue-200' },
            emerald: { label: 'Emerald', bgHeader: 'bg-emerald-900', bgPrimary: 'bg-emerald-600', textPrimary: 'text-emerald-700', bgLight: 'bg-emerald-50', border: 'border-emerald-200' },
            royal: { label: 'Royal', bgHeader: 'bg-indigo-900', bgPrimary: 'bg-indigo-600', textPrimary: 'text-indigo-700', bgLight: 'bg-indigo-50', border: 'border-indigo-200' },
            midnight: { label: 'Midnight', bgHeader: 'bg-black', bgPrimary: 'bg-black', textPrimary: 'text-gray-800', bgLight: 'bg-gray-200', border: 'border-gray-400' }
        };

        const MONTHS = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const COLORS = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6', '#f97316', '#64748b'];

        const generateId = (name) => name.toLowerCase().replace(/[^a-z0-9]/g, '') + '_' + Date.now();
        const getEmptyYear = () => {
            const y = {};
            for (let i = 0; i < 12; i++) {
                y[i] = { income: [], expenses: {}, spent: {}, transactions: {}, debts: {}, variableCategories: [{ id: 'groceries', label: 'Groceries' }, { id: 'gas', label: 'Gas' }] };
            }
            return y;
        };

        const DEFAULT_DATA = {
            categories: {
                fixed: [ { id: 'housing', label: 'Housing', items: [{id: 'rent', label: 'Rent'}, {id: 'trash', label: 'Trash'}] }, { id: 'insurance', label: 'Insurance', items: [{id: 'car_ins', label: 'Car Insurance'}] } ],
                savings: [ { id: 'buckets', label: 'Buckets', items: [{id: 'roth', label: 'Roth IRA'}] } ]
            },
            assets: [], debts: [], savingsGoals: [],
            years: { [new Date().getFullYear()]: getEmptyYear() },
            preferences: { theme: 'ocean', darkMode: false, compactMode: false }
        };

        // --- MONEY COMPONENT (HANDLES PRIVACY) ---
        const Money = ({ value, privacyMode, prefix = "$" }) => {
            return <span className={privacyMode ? "blur-val font-mono" : "font-mono"}>{prefix}{Number(value).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>;
        };

        const SummaryBlock = ({ stats, title, theme, privacyMode }) => (
            <div className={`${theme.bgHeader} text-white p-6 rounded-xl mt-4 shadow-lg border border-slate-700`}>
                <h3 className="font-bold text-slate-200 border-b border-slate-600 pb-2 mb-4 text-lg">{title}</h3>
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-6 text-center">
                    <div><p className="text-xs text-slate-400 uppercase tracking-wider">Total Income</p><p className="text-xl font-bold text-green-400"><Money value={stats.income} privacyMode={privacyMode} /></p></div>
                    <div><p className="text-xs text-slate-400 uppercase tracking-wider">Total Budgeted</p><p className="text-xl font-bold text-blue-400"><Money value={stats.budgeted} privacyMode={privacyMode} /></p></div>
                    <div><p className="text-xs text-slate-400 uppercase tracking-wider">Total Spent</p><p className="text-xl font-bold text-red-400"><Money value={stats.spent} privacyMode={privacyMode} /></p></div>
                    <div><p className="text-xs text-slate-400 uppercase tracking-wider">Remaining Cash</p><p className={`text-xl font-bold ${stats.remaining>=0?'text-green-400':'text-red-400'}`}><Money value={stats.remaining} privacyMode={privacyMode} /></p></div>
                    <div><p className="text-xs text-slate-400 uppercase tracking-wider">Proj. Savings</p><p className="text-xl font-bold text-purple-400"><Money value={stats.saved} privacyMode={privacyMode} /></p></div>
                    <div><p className="text-xs text-slate-400 uppercase tracking-wider">Savings Rate</p><p className="text-xl font-bold text-purple-400">{stats.rate}%</p></div>
                </div>
            </div>
        );

        const FinancialOS = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [data, setData] = useState(null);
            const [activeTab, setActiveTab] = useState('budget');
            const [settingsOpen, setSettingsOpen] = useState(false);
            const [privacyMode, setPrivacyMode] = useState(false); // Local toggle state for privacy
            
            const [expandedYears, setExpandedYears] = useState([new Date().getFullYear().toString()]);
            const [expandedMonths, setExpandedMonths] = useState({});
            const [activeTransactionCategory, setActiveTransactionCategory] = useState(null);
            const [analyticsYear, setAnalyticsYear] = useState('All Time');
            const [analyticsMonth, setAnalyticsMonth] = useState('Whole Year');
            
            // Modal State
            const [selectedItem, setSelectedItem] = useState(null); 
            const [logDate, setLogDate] = useState(new Date().toISOString().split('T')[0]);
            const [logAmount, setLogAmount] = useState('');

            const [inputs, setInputs] = useState({ year: '', cat: '', itemDesc: '', itemAmt: '', assetName: '', assetVal: '', debtName: '', debtBal: '', debtRate: '', goalName: '', goalTarget: '', incName: '', incAmt: '', varCat: '', saveCat: '', newGroup: '', newItem: '', targetGroup: '' });
            const [debtSimExtra, setDebtSimExtra] = useState(0);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(u => {
                    if (u) setUser(u);
                    else { setUser(null); setData(null); setLoading(false); }
                });
                return unsubscribe;
            }, []);

            useEffect(() => {
                if (user) {
                    setLoading(true);
                    const docRef = db.collection('users').doc(user.uid);
                    const unsubscribe = docRef.onSnapshot(doc => {
                        if (doc.exists) {
                            let fetchedData = doc.data();
                            // Ensure preferences exist
                            if (!fetchedData.preferences) fetchedData.preferences = DEFAULT_DATA.preferences;
                            setData(fetchedData);
                        } else {
                            docRef.set(DEFAULT_DATA);
                            setData(DEFAULT_DATA);
                        }
                        setLoading(false);
                    }, (err) => setLoading(false));
                    return unsubscribe;
                }
            }, [user]);

            useEffect(() => {
                if (user && data && !loading) {
                    const timer = setTimeout(() => db.collection('users').doc(user.uid).set(data), 1000);
                    return () => clearTimeout(timer);
                }
            }, [data, user, loading]);

            // --- THEME & STYLE HELPERS ---
            const currentTheme = data && data.preferences ? THEMES[data.preferences.theme] : THEMES.ocean;
            const isDark = data && data.preferences ? data.preferences.darkMode : false;
            const isCompact = data && data.preferences ? data.preferences.compactMode : false;

            // Apply dark mode to body
            useEffect(() => {
                if(isDark) {
                    document.body.classList.add('bg-slate-900', 'text-slate-200');
                    document.body.classList.remove('bg-gray-100', 'text-slate-800');
                } else {
                    document.body.classList.add('bg-gray-100', 'text-slate-800');
                    document.body.classList.remove('bg-slate-900', 'text-slate-200');
                }
            }, [isDark]);

            const cardClass = isDark ? "bg-slate-800 border-slate-700 text-slate-200" : "bg-white border-gray-200";
            const inputClass = isDark ? "bg-slate-700 border-slate-600 text-white placeholder-gray-400" : "bg-white border-gray-300";
            const mutedText = isDark ? "text-slate-400" : "text-gray-500";
            const paddingClass = isCompact ? "p-2" : "p-4";
            const textSizeClass = isCompact ? "text-xs" : "text-sm";

            const updatePreference = (key, value) => {
                setData(d => ({...d, preferences: { ...d.preferences, [key]: value }}));
            };

            const login = () => auth.signInWithPopup(googleProvider).catch(e => alert(e.message));
            const logout = () => { auth.signOut(); setUser(null); setData(null); };

            const getCurrentValue = (item) => {
                if (!item.history || item.history.length === 0) return 0;
                const sorted = [...item.history].sort((a, b) => b.date.localeCompare(a.date));
                return sorted[0].value;
            };

            const getValueAtDate = (item, targetDate) => {
                if (!item.history || item.history.length === 0) return 0;
                const validLogs = item.history.filter(h => h.date <= targetDate);
                if (validLogs.length === 0) return 0; 
                validLogs.sort((a,b) => b.date.localeCompare(a.date));
                return validLogs[0].value;
            };

            const getCatSpent = (m, catId) => m.transactions?.[catId]?.reduce((s, t) => s + t.amount, 0) || 0;
            const getMonthIncome = (m) => m.income.reduce((s, i) => s + i.amount, 0);

            const calculateStats = (monthsArray) => {
                if (!data) return { income: 0, budgeted: 0, spent: 0, saved: 0, debtPaid: 0, remaining: 0, rate: 0 };
                let s = { income: 0, budgeted: 0, spent: 0, saved: 0, debtPaid: 0 };
                
                monthsArray.forEach(m => {
                    s.income += getMonthIncome(m);
                    data.categories.fixed.forEach(group => {
                        group.items.forEach(c => {
                            s.budgeted += (m.expenses[c.id] || 0);
                            s.spent += (m.spent[c.id] || 0);
                        });
                    });
                    const varCats = m.variableCategories || [];
                    varCats.forEach(c => {
                        s.budgeted += (m.expenses[c.id] || 0);
                        s.spent += getCatSpent(m, c.id);
                    });
                    data.categories.savings.forEach(group => {
                        group.items.forEach(c => {
                            s.budgeted += (m.expenses[c.id] || 0);
                            s.saved += (m.spent[c.id] || 0);
                        });
                    });
                    data.debts.forEach(d => {
                        s.debtPaid += (m.debts?.[d.id]?.payment || 0);
                        s.spent += (m.debts?.[d.id]?.payment || 0);
                    });
                });
                s.remaining = s.income - (s.spent + s.saved);
                s.rate = s.income > 0 ? ((s.saved / s.income) * 100).toFixed(1) : "0.0";
                return s;
            };

            const updateMonth = (y, mIdx, cb) => setData(d => ({ ...d, years: { ...d.years, [y]: { ...d.years[y], [mIdx]: cb(d.years[y][mIdx]) } } }));
            
            const addGroup = (type, name) => {
                if(!name) return;
                const id = generateId(name);
                setData(d => ({...d, categories: {...d.categories, [type]: [...d.categories[type], {id, label: name, items: []}]}}));
                setInputs(prev => ({...prev, newGroup: ''}));
            };
            const deleteGroup = (type, groupId) => {
                if(confirm("Delete entire group and all items inside?")) {
                    setData(d => ({...d, categories: {...d.categories, [type]: d.categories[type].filter(g => g.id !== groupId)}}));
                }
            };
            const addItemToGroup = (type, groupId, name) => {
                if(!name) return;
                const id = generateId(name);
                setData(d => ({...d, categories: {...d.categories, [type]: d.categories[type].map(g => g.id === groupId ? {...g, items: [...g.items, {id, label: name}]} : g)}}));
                setInputs(prev => ({...prev, newItem: '', targetGroup: ''}));
            };
            const deleteItemFromGroup = (type, groupId, itemId) => {
                if(confirm("Delete item?")) {
                    setData(d => ({...d, categories: {...d.categories, [type]: d.categories[type].map(g => g.id === groupId ? {...g, items: g.items.filter(i => i.id !== itemId)} : g)}}));
                }
            };

            const addCategory = (year, mIdx, name) => {
                if(!name) return;
                const id = generateId(name);
                updateMonth(year, mIdx, m => ({...m, variableCategories: [...(m.variableCategories || []), {id, label: name}]}));
                setInputs(prev => ({...prev, varCat: ''}));
            };
            const deleteCategory = (year, mIdx, id) => {
                if(confirm("Delete category?")) updateMonth(year, mIdx, m => ({...m, variableCategories: m.variableCategories.filter(c => c.id !== id)}));
            };
            
            const deleteYear = (year) => {
                if(confirm(`Delete ${year}?`)) setData(d => { const newYears = { ...d.years }; delete newYears[year]; return { ...d, years: newYears }; });
            };

            const autofillBudget = (year, sourceMonthIdx) => {
                if(!confirm("Copy budget?")) return;
                const sourceExpenses = data.years[year][sourceMonthIdx].expenses;
                setData(d => {
                    const updatedYear = { ...d.years[year] };
                    for (let i = 0; i < 12; i++) if (i !== sourceMonthIdx) updatedYear[i] = { ...updatedYear[i], expenses: { ...sourceExpenses } };
                    return { ...d, years: { ...d.years, [year]: updatedYear } };
                });
            };

            const autofillSpent = (year, mIdx) => {
                if(!confirm("Match spent to budget?")) return;
                setData(d => {
                    const currentMonth = d.years[year][mIdx];
                    const newSpent = { ...currentMonth.spent }; 
                    d.categories.fixed.forEach(group => group.items.forEach(item => { if (currentMonth.expenses[item.id]) newSpent[item.id] = currentMonth.expenses[item.id]; }));
                    d.categories.savings.forEach(group => group.items.forEach(item => { if (currentMonth.expenses[item.id]) newSpent[item.id] = currentMonth.expenses[item.id]; }));
                    return { ...d, years: { ...d.years, [year]: { ...d.years[year], [mIdx]: { ...currentMonth, spent: newSpent } } } };
                });
            };

            const copyFromPrevious = (year, mIdx) => {
                let prevYear = year;
                let prevMonthIdx = mIdx - 1;
                if (prevMonthIdx < 0) { prevYear = (parseInt(year) - 1).toString(); prevMonthIdx = 11; }
                if (!data.years[prevYear]) { alert("No previous year."); return; }
                const prevMonthData = data.years[prevYear][prevMonthIdx];
                if(confirm(`Copy from ${MONTHS[prevMonthIdx]}?`)) {
                    updateMonth(year, mIdx, m => ({...m, variableCategories: [...(prevMonthData.variableCategories || [])], expenses: { ...m.expenses, ...prevMonthData.expenses }}));
                }
            };

            const addLog = () => {
                if (!selectedItem || !logAmount) return;
                const type = selectedItem.type; 
                const newItem = { date: logDate, value: parseFloat(logAmount) };
                setData(d => ({...d, [type]: d[type].map(item => { if (item.id === selectedItem.id) return { ...item, history: [...(item.history || []), newItem] }; return item; })}));
                setLogAmount('');
            };

            const deleteLog = (logIndex) => {
                if (!confirm("Remove entry?")) return;
                const type = selectedItem.type;
                setData(d => ({...d, [type]: d[type].map(item => { if (item.id === selectedItem.id) return { ...item, history: item.history.filter((_, idx) => idx !== logIndex) }; return item; })}));
            };

            // --- VIEWS ---
            if (loading || (user && !data)) return <div className={`h-screen flex items-center justify-center flex-col ${isDark?'bg-slate-900':'bg-gray-100'}`}><div className="loader mb-4"></div><p className="font-bold animate-pulse text-gray-500">Loading Profile...</p></div>;

            if (!user) return <div className="h-screen flex flex-col items-center justify-center bg-gray-100 p-4"><div className="bg-white p-8 rounded-xl shadow-lg max-w-md w-full text-center"><h1 className="text-3xl font-extrabold text-slate-800 mb-2">Financial OS</h1><p className="text-gray-500 mb-8">Secure, Multi-Year Budget Tracking</p><button onClick={login} className="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg w-full hover:bg-blue-700 transition flex items-center justify-center gap-2"><svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12.545 10.239v3.821h5.445c-0.712 2.315-2.647 3.972-5.445 3.972-3.332 0-6.033-2.531-6.033-5.652s2.701-5.652 6.033-5.652c1.498 0 2.866 0.549 3.921 1.453l2.814-2.814c-1.79-1.677-4.184-2.702-6.735-2.702-5.522 0-10 4.478-10 10s4.478 10 10 10c8.396 0 10.249-7.85 9.426-11.748l-9.426-0.001z"/></svg> Sign In with Google</button></div></div>;

            // SETTINGS MODAL
            const renderSettings = () => (
                <div className="fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4" onClick={()=>setSettingsOpen(false)}>
                    <div className={`rounded-xl shadow-2xl w-full max-w-sm overflow-hidden ${isDark ? 'bg-slate-800 text-white' : 'bg-white text-slate-800'}`} onClick={e=>e.stopPropagation()}>
                        <div className={`p-4 flex justify-between items-center ${currentTheme.bgHeader} text-white`}>
                            <h3 className="font-bold">Settings</h3>
                            <button onClick={()=>setSettingsOpen(false)}><Icons.X/></button>
                        </div>
                        <div className="p-6 space-y-6">
                            <div className="flex justify-between items-center">
                                <span className="font-bold">Dark Mode</span>
                                <button onClick={()=>updatePreference('darkMode', !isDark)} className={`w-12 h-6 rounded-full transition p-1 ${isDark ? 'bg-green-500' : 'bg-gray-300'}`}><div className={`w-4 h-4 bg-white rounded-full shadow-md transform transition ${isDark ? 'translate-x-6' : ''}`}></div></button>
                            </div>
                            <div className="flex justify-between items-center">
                                <span className="font-bold">Compact Mode</span>
                                <button onClick={()=>updatePreference('compactMode', !isCompact)} className={`w-12 h-6 rounded-full transition p-1 ${isCompact ? 'bg-green-500' : 'bg-gray-300'}`}><div className={`w-4 h-4 bg-white rounded-full shadow-md transform transition ${isCompact ? 'translate-x-6' : ''}`}></div></button>
                            </div>
                            <div>
                                <span className="font-bold block mb-3">Accent Color</span>
                                <div className="grid grid-cols-4 gap-2">
                                    {Object.entries(THEMES).map(([key, t]) => (
                                        <button key={key} onClick={()=>updatePreference('theme', key)} className={`h-10 rounded-lg border-2 ${t.bgPrimary} ${data.preferences.theme === key ? 'border-white shadow-lg ring-2 ring-blue-400' : 'border-transparent opacity-80'}`}></button>
                                    ))}
                                </div>
                                <p className="text-xs text-center mt-1 opacity-60 capitalize">{data.preferences.theme} Theme</p>
                            </div>
                        </div>
                    </div>
                </div>
            );

            const renderBudget = () => (
                <div className="space-y-6">
                    {Object.keys(data.years).sort().map(year => {
                        const yearStats = calculateStats(Object.values(data.years[year]));
                        return (
                            <div key={year} className={`border rounded-xl shadow-sm overflow-hidden ${cardClass}`}>
                                <div onClick={() => setExpandedYears(prev => prev.includes(year) ? prev.filter(y=>y!==year) : [...prev, year])} className={`${currentTheme.bgHeader} text-white p-4 flex justify-between items-center cursor-pointer hover:opacity-90`}>
                                    <div className="flex items-center gap-4"><h2 className="text-xl font-bold flex gap-2"><Icons.Calendar/> {year}</h2><button onClick={(e) => { e.stopPropagation(); deleteYear(year); }} className="text-slate-400 hover:text-red-400 p-1"><Icons.Trash /></button></div>
                                    {expandedYears.includes(year) ? <Icons.ChevronUp/> : <Icons.ChevronDown/>}
                                </div>
                                {expandedYears.includes(year) && (
                                    <div className="p-4 grid gap-4">
                                        {MONTHS.map((monthName, mIdx) => {
                                            const mData = data.years[year][mIdx];
                                            const isExpanded = (expandedMonths[year] || []).includes(mIdx);
                                            const mStats = calculateStats([mData]);
                                            return (
                                                <div key={mIdx} className={`border rounded-lg ${isExpanded ? 'ring-2 ring-blue-100' : ''} ${isDark ? 'border-slate-600' : ''}`}>
                                                    <div onClick={() => setExpandedMonths(prev => ({...prev, [year]: prev[year]?.includes(mIdx) ? prev[year].filter(m=>m!==mIdx) : [...(prev[year]||[]), mIdx]}))} className={`p-3 flex justify-between items-center cursor-pointer ${isDark ? 'hover:bg-slate-700' : 'hover:bg-gray-50'}`}>
                                                        <span className="font-bold w-24">{monthName}</span>
                                                        <div className={`flex gap-4 text-sm hidden md:flex ${mutedText}`}>
                                                            <span>In: <b className="text-green-500"><Money value={mStats.income} privacyMode={privacyMode}/></b></span>
                                                            <span>Out: <b className="text-red-500"><Money value={mStats.spent} privacyMode={privacyMode}/></b></span>
                                                            <span>Rem: <b className={mStats.remaining >= 0 ? 'text-green-500' : 'text-red-500'}><Money value={mStats.remaining} privacyMode={privacyMode}/></b></span>
                                                        </div>
                                                        {isExpanded ? <Icons.ChevronUp/> : <Icons.ChevronDown/>}
                                                    </div>
                                                    {isExpanded && (
                                                        <div className={`${paddingClass} ${isDark ? 'bg-slate-900' : 'bg-white'}`}>
                                                            <div className="flex flex-wrap justify-end gap-2 mb-4">
                                                                <button onClick={()=>copyFromPrevious(year, mIdx)} className={`text-xs flex items-center gap-1 px-3 py-1 rounded transition border ${isDark ? 'bg-slate-800 border-slate-600 hover:bg-slate-700' : 'bg-gray-100 hover:bg-gray-200 border-gray-200'}`}><Icons.Copy/> Copy from {mIdx === 0 ? "Dec" : MONTHS[mIdx-1]}</button>
                                                                <button onClick={()=>autofillSpent(year, mIdx)} className="text-xs flex items-center gap-1 bg-green-100 text-green-700 px-3 py-1 rounded hover:bg-green-200 transition border border-green-200"><Icons.Check/> Match Spent to Budget</button>
                                                                <button onClick={()=>autofillBudget(year, mIdx)} className="text-xs flex items-center gap-1 bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200 transition border border-blue-200"><Icons.Bolt/> Apply Budget to All Months</button>
                                                            </div>
                                                            <div className="grid lg:grid-cols-2 gap-6 mb-6">
                                                                <div className="space-y-6">
                                                                    <div className={`${currentTheme.bgLight} ${paddingClass} rounded border ${currentTheme.border} ${isDark ? 'bg-opacity-10 border-opacity-20' : ''}`}>
                                                                        <h4 className={`text-xs font-bold uppercase mb-2 ${currentTheme.textPrimary}`}>Income Sources</h4>
                                                                        {mData.income.map((inc, idx) => (
                                                                            <div key={idx} className={`flex justify-between ${textSizeClass} mb-1`}>
                                                                                <span>{inc.label}</span><Money value={inc.amount} privacyMode={privacyMode}/><button onClick={()=>updateMonth(year, mIdx, m => ({...m, income: m.income.filter((_,i)=>i!==idx)}))} className="text-red-400"><Icons.Trash/></button>
                                                                            </div>
                                                                        ))}
                                                                        <div className="flex gap-1 mt-2">
                                                                            <input placeholder="Source" className={`w-full ${textSizeClass} border rounded px-1 ${inputClass}`} value={inputs.incName} onChange={e=>setInputs({...inputs, incName: e.target.value})} />
                                                                            <input placeholder="$" type="number" className={`w-16 ${textSizeClass} border rounded px-1 ${inputClass}`} value={inputs.incAmt} onChange={e=>setInputs({...inputs, incAmt: e.target.value})} />
                                                                            <button onClick={()=>{ if(inputs.incName && inputs.incAmt) { updateMonth(year, mIdx, m => ({...m, income: [...m.income, {label: inputs.incName, amount: parseFloat(inputs.incAmt)}]})); setInputs({...inputs, incName: '', incAmt: ''}); } }} className={`${currentTheme.bgPrimary} text-white rounded px-1`}><Icons.Plus/></button>
                                                                        </div>
                                                                    </div>
                                                                    <div>
                                                                        <h4 className={`font-bold ${textSizeClass} ${mutedText} border-b mb-4 ${isDark ? 'border-slate-700' : ''}`}>Fixed Expenses</h4>
                                                                        {data.categories.fixed.map(group => (
                                                                            <div key={group.id} className={`mb-4 border rounded p-2 ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-gray-50'}`}>
                                                                                <div className={`flex justify-between items-center mb-2 border-b pb-1 ${isDark ? 'border-slate-700' : ''}`}>
                                                                                    <span className="font-bold text-xs uppercase tracking-wider">{group.label}</span>
                                                                                    <button onClick={()=>deleteGroup('fixed', group.id)} className="text-gray-400 hover:text-red-400"><Icons.Trash/></button>
                                                                                </div>
                                                                                <div className="space-y-1">
                                                                                    {group.items.map(c => (
                                                                                        <div key={c.id} className={`flex justify-between items-center ${textSizeClass} pl-2`}>
                                                                                            <span className="flex items-center gap-1 group">{c.label} <button onClick={()=>deleteItemFromGroup('fixed', group.id, c.id)} className="opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-400"><Icons.Trash/></button></span>
                                                                                            <div className="flex gap-1"><input type="number" className={`w-16 border rounded px-1 ${inputClass}`} value={mData.expenses[c.id]||''} placeholder="Bud" onChange={e=>updateMonth(year, mIdx, m => ({...m, expenses: {...m.expenses, [c.id]: parseFloat(e.target.value)||0}}))} /><input type="number" className={`w-16 border rounded px-1 ${inputClass}`} value={mData.spent[c.id]||''} placeholder="Pay" onChange={e=>updateMonth(year, mIdx, m => ({...m, spent: {...m.spent, [c.id]: parseFloat(e.target.value)||0}}))} /></div>
                                                                                        </div>
                                                                                    ))}
                                                                                    <div className="flex flex-col sm:flex-row gap-2 mt-2 pl-2">
                                                                                        <input placeholder="New Item" className={`w-full text-[10px] border rounded px-1 ${inputClass}`} value={inputs.targetGroup === group.id ? inputs.newItem : ''} onChange={e=>setInputs({...inputs, newItem: e.target.value, targetGroup: group.id})}/>
                                                                                        <button onClick={()=>{ if(inputs.targetGroup === group.id) addItemToGroup('fixed', group.id, inputs.newItem); }} className="bg-gray-200 rounded px-1 text-[10px] text-black w-full sm:w-auto"><Icons.Plus/></button>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        ))}
                                                                        <div className="flex flex-col sm:flex-row gap-2 mt-4">
                                                                            <input placeholder="New Fixed Group" className={`w-full text-xs border rounded px-1 font-bold ${inputClass}`} value={inputs.newGroup} onChange={e=>setInputs({...inputs, newGroup: e.target.value})}/>
                                                                            <button onClick={()=>addGroup('fixed', inputs.newGroup)} className={`${currentTheme.bgPrimary} text-white rounded px-2 py-1 text-xs w-full sm:w-auto`}>Add Group</button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div className="space-y-6">
                                                                    <div className={`${isDark ? 'bg-slate-800 border-slate-700' : 'bg-purple-50 border-purple-100'} ${paddingClass} rounded border`}>
                                                                        <h4 className={`text-xs font-bold uppercase mb-4 ${isDark ? 'text-purple-400' : 'text-purple-800'}`}>SAVINGS & INVESTMENTS</h4>
                                                                        {data.categories.savings.map(group => (
                                                                            <div key={group.id} className={`mb-4 border rounded p-2 ${isDark ? 'bg-slate-700 border-slate-600' : 'bg-purple-50/50 border-purple-200'}`}>
                                                                                <div className={`flex justify-between items-center mb-2 border-b pb-1 ${isDark ? 'border-slate-600' : 'border-purple-200'}`}>
                                                                                    <span className={`font-bold text-xs uppercase tracking-wider ${isDark ? 'text-purple-300' : 'text-purple-700'}`}>{group.label}</span>
                                                                                    <button onClick={()=>deleteGroup('savings', group.id)} className="text-purple-300 hover:text-red-400"><Icons.Trash/></button>
                                                                                </div>
                                                                                <div className="space-y-1">
                                                                                    {group.items.map(c => (
                                                                                        <div key={c.id} className={`flex justify-between items-center ${textSizeClass} pl-2`}>
                                                                                            <span className={`flex items-center gap-1 group ${isDark ? 'text-purple-200' : 'text-purple-900'}`}>{c.label} <button onClick={()=>deleteItemFromGroup('savings', group.id, c.id)} className="opacity-0 group-hover:opacity-100 text-purple-300 hover:text-red-400"><Icons.Trash/></button></span>
                                                                                            <div className="flex gap-1"><input type="number" className={`w-16 border rounded px-1 ${inputClass}`} value={mData.expenses[c.id]||''} placeholder="Goal" onChange={e=>updateMonth(year, mIdx, m => ({...m, expenses: {...m.expenses, [c.id]: parseFloat(e.target.value)||0}}))} /><input type="number" className={`w-16 border rounded px-1 ${inputClass}`} value={mData.spent[c.id]||''} placeholder="Saved" onChange={e=>updateMonth(year, mIdx, m => ({...m, spent: {...m.spent, [c.id]: parseFloat(e.target.value)||0}}))} /></div>
                                                                                        </div>
                                                                                    ))}
                                                                                    <div className="flex flex-col sm:flex-row gap-2 mt-2 pl-2">
                                                                                        <input placeholder="New Bucket" className={`w-full text-[10px] border rounded px-1 ${inputClass}`} value={inputs.targetGroup === group.id ? inputs.newItem : ''} onChange={e=>setInputs({...inputs, newItem: e.target.value, targetGroup: group.id})}/>
                                                                                        <button onClick={()=>{ if(inputs.targetGroup === group.id) addItemToGroup('savings', group.id, inputs.newItem); }} className="bg-purple-600 text-white rounded px-1 text-[10px] w-full sm:w-auto"><Icons.Plus/></button>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        ))}
                                                                        <div className="flex flex-col sm:flex-row gap-2 mt-4">
                                                                            <input placeholder="New Savings Group" className={`w-full text-xs border rounded px-1 font-bold ${inputClass}`} value={inputs.saveCat} onChange={e=>setInputs({...inputs, saveCat: e.target.value})}/>
                                                                            <button onClick={()=>{ addGroup('savings', inputs.saveCat); setInputs({...inputs, saveCat: ''}) }} className="bg-purple-600 text-white rounded px-2 py-1 text-xs w-full sm:w-auto">Add Group</button>
                                                                        </div>
                                                                    </div>
                                                                    <div>
                                                                        <h4 className={`font-bold ${textSizeClass} ${mutedText} border-b mb-2 ${isDark ? 'border-slate-700' : ''}`}>Variable Expenses</h4>
                                                                        <div className="space-y-2">
                                                                            {(mData.variableCategories || []).map(c => {
                                                                                const spent = getCatSpent(mData, c.id);
                                                                                const bud = mData.expenses[c.id] || 0;
                                                                                const remaining = bud - spent;
                                                                                const isOpen = activeTransactionCategory?.year === year && activeTransactionCategory?.month === mIdx && activeTransactionCategory?.cat === c.id;
                                                                                return (
                                                                                    <div key={c.id} className={`text-xs border rounded p-2 ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-gray-50'}`}>
                                                                                        <div className="flex justify-between items-center mb-1">
                                                                                            <div className="flex gap-1 items-center"><span onClick={()=>setActiveTransactionCategory(isOpen ? null : {year, month: mIdx, cat: c.id})} className={`font-bold cursor-pointer hover:underline ${currentTheme.textPrimary}`}>{c.label}</span><button onClick={()=>deleteCategory(year, mIdx, c.id)} className="text-gray-300 hover:text-red-400"><Icons.Trash/></button></div>
                                                                                            <div className="flex gap-2 items-center"><input type="number" className={`w-16 border rounded px-1 h-6 text-right ${inputClass}`} value={mData.expenses[c.id]||''} placeholder="Bud" onChange={e=>updateMonth(year, mIdx, m => ({...m, expenses: {...m.expenses, [c.id]: parseFloat(e.target.value)||0}}))} /><div className="flex flex-col items-end w-16"><span className={`text-[10px] ${mutedText}`}>Spent: <Money value={spent} privacyMode={privacyMode} prefix="$"/></span><span className={`text-[10px] font-bold ${remaining < 0 ? 'text-red-500' : 'text-green-600'}`}>Left: <Money value={remaining} privacyMode={privacyMode} prefix="$"/></span></div></div>
                                                                                        </div>
                                                                                        {isOpen && (
                                                                                            <div className={`p-2 mt-1 border-t ${isDark ? 'bg-slate-900 border-slate-600' : 'bg-white'}`}>
                                                                                                <div className="flex flex-col sm:flex-row gap-2 mb-2"><input placeholder="Item" className={`border rounded w-full px-1 ${inputClass}`} value={inputs.itemDesc} onChange={e=>setInputs({...inputs, itemDesc: e.target.value})} /><input type="number" placeholder="$" className={`border rounded w-full sm:w-20 px-1 ${inputClass}`} value={inputs.itemAmt} onChange={e=>setInputs({...inputs, itemAmt: e.target.value})} /><button onClick={()=>{ if(inputs.itemDesc && inputs.itemAmt){ const t = {id: Date.now(), desc: inputs.itemDesc, amount: parseFloat(inputs.itemAmt)}; updateMonth(year, mIdx, m => ({...m, transactions: {...m.transactions, [c.id]: [...(m.transactions[c.id]||[]), t]}})); setInputs({...inputs, itemDesc:'', itemAmt:''}); } }} className="bg-green-500 text-white rounded px-2 py-1 w-full sm:w-auto"><Icons.Plus/></button></div>
                                                                                                {mData.transactions[c.id]?.map(t => (<div key={t.id} className={`flex justify-between border-b py-1 ${isDark ? 'border-slate-700' : ''}`}><span>{t.desc}</span><div className="flex gap-2"><Money value={t.amount} privacyMode={privacyMode} prefix="$"/><button onClick={()=>{ if(confirm("Delete this transaction?")) { updateMonth(year, mIdx, m => ({...m, transactions: {...m.transactions, [c.id]: m.transactions[c.id].filter(x=>x.id!==t.id)}})) }}} className="text-red-400"><Icons.Trash/></button></div></div>))}
                                                                                            </div>
                                                                                        )}
                                                                                    </div>
                                                                                )
                                                                            })}
                                                                            <div className="pt-2 flex flex-col sm:flex-row gap-2"><input placeholder="New Variable Cat" className={`w-full text-xs border rounded px-1 ${inputClass}`} value={inputs.varCat} onChange={e=>setInputs({...inputs, varCat:e.target.value})}/><button onClick={()=>addCategory(year, mIdx, inputs.varCat)} className="bg-gray-200 rounded px-2 w-full sm:w-auto text-black"><Icons.Plus/></button></div>
                                                                        </div>
                                                                    </div>
                                                                    <div className="bg-red-50 p-3 rounded border border-red-100">
                                                                        <h4 className="text-xs font-bold text-red-800 uppercase mb-2">Debt Payments</h4>
                                                                        {data.debts.map(d => (
                                                                            <div key={d.id} className="flex justify-between items-center text-xs mb-1"><span>{d.label}</span><input type="number" placeholder="Paid" className="w-16 border border-red-200 rounded px-1 text-black" value={mData.debts?.[d.id]?.payment || ''} onChange={e=>updateMonth(year, mIdx, m => ({...m, debts: {...m.debts, [d.id]: {...(m.debts?.[d.id]||{}), payment: parseFloat(e.target.value)||0}}}))} /></div>
                                                                        ))}
                                                                        {data.debts.length===0 && <span className="text-xs text-gray-400 italic">Add debts in Net Worth tab</span>}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <SummaryBlock stats={mStats} title={`${monthName} Summary`} theme={currentTheme} privacyMode={privacyMode} />
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                        <SummaryBlock stats={yearStats} title={`${year} Annual Summary`} theme={currentTheme} privacyMode={privacyMode} />
                                    </div>
                                )}
                            </div>
                        );
                    })}
                    <div className="flex justify-center gap-2"><input type="number" placeholder="YYYY" className={`border px-2 py-1 rounded w-24 ${inputClass}`} id="newYearInput" /><button onClick={()=>{ const y = document.getElementById('newYearInput').value; if(y && !data.years[y]) setData(d => ({...d, years: {...d.years, [y]: getEmptyYear()}})); }} className={`${currentTheme.bgHeader} text-white px-4 py-1 rounded`}>Add Year</button></div>
                </div>
            );

            const renderNetWorth = () => {
                const totalAssets = data.assets.reduce((sum, a) => sum + getCurrentValue(a), 0);
                const totalLiabilities = data.debts.reduce((sum, d) => sum + getCurrentValue(d), 0);

                const openModal = (item, type) => {
                    setSelectedItem({...item, type});
                    setLogAmount('');
                    setLogDate(new Date().toISOString().split('T')[0]);
                };

                const historyMap = {};
                [...data.assets, ...data.debts].forEach(item => {
                    (item.history || []).forEach(log => { historyMap[log.date] = true; });
                });
                const sortedDates = Object.keys(historyMap).sort();
                const chartData = sortedDates.map(date => {
                    let assetsVal = 0, debtsVal = 0;
                    data.assets.forEach(a => assetsVal += getValueAtDate(a, date));
                    data.debts.forEach(d => debtsVal += getValueAtDate(d, date));
                    return { date, assets: assetsVal, debts: debtsVal };
                });
                const maxVal = Math.max(...chartData.map(d => Math.max(d.assets, d.debts)), 100);
                const getPoints = (key) => chartData.map((d, i) => {
                    const x = (i / (chartData.length - 1 || 1)) * 300;
                    const y = 100 - (d[key] / maxVal) * 100;
                    return `${x},${y}`;
                }).join(' ');

                return (
                    <div>
                        {chartData.length > 1 && (
                            <div className={`${cardClass} p-6 rounded-xl shadow-sm mb-8`}>
                                <h3 className={`font-bold mb-4 ${mutedText}`}>Net Worth Trend</h3>
                                <div className={`h-48 w-full relative border-l border-b mb-8 ml-8 ${isDark ? 'border-slate-600' : 'border-gray-200'}`}>
                                    <svg viewBox="0 0 300 100" className="w-full h-full overflow-visible" preserveAspectRatio="none">
                                        <line x1="0" y1="0" x2="300" y2="0" stroke={isDark?"#475569":"#e5e7eb"} strokeWidth="1" strokeDasharray="4" />
                                        <line x1="0" y1="50" x2="300" y2="50" stroke={isDark?"#475569":"#e5e7eb"} strokeWidth="1" strokeDasharray="4" />
                                        <polyline fill="none" stroke="#22c55e" strokeWidth="2" points={getPoints('assets')} />
                                        <polyline fill="none" stroke="#ef4444" strokeWidth="2" points={getPoints('debts')} />
                                        {chartData.map((d, i) => {
                                            const x = (i / (chartData.length - 1 || 1)) * 300;
                                            return <g key={i}><circle cx={x} cy={100 - (d.assets / maxVal) * 100} r="3" fill="#22c55e" /><circle cx={x} cy={100 - (d.debts / maxVal) * 100} r="3" fill="#ef4444" /></g>;
                                        })}
                                    </svg>
                                    <div className={`absolute -left-12 -top-3 text-xs w-10 text-right ${mutedText}`}>${(maxVal/1000).toLocaleString()}k</div>
                                    <div className={`absolute -left-12 -bottom-3 text-xs w-10 text-right ${mutedText}`}>$0</div>
                                    <div className={`absolute -bottom-6 left-0 text-xs ${mutedText}`}>{chartData[0].date}</div>
                                    <div className={`absolute -bottom-6 right-0 text-xs ${mutedText}`}>{chartData[chartData.length-1].date}</div>
                                </div>
                            </div>
                        )}
                        <div className="grid md:grid-cols-2 gap-8">
                            <div className={`${cardClass} p-6 rounded-xl shadow-sm border-t-4 border-green-500`}>
                                <h2 className={`text-2xl font-bold mb-4 flex justify-between ${isDark ? 'text-white' : 'text-slate-800'}`}><span>Assets</span><span className="text-green-600"><Money value={totalAssets} privacyMode={privacyMode}/></span></h2>
                                <div className="space-y-3 mb-6">
                                    {data.assets.map(a => (
                                        <div key={a.id} onClick={()=>openModal(a, 'assets')} className={`flex justify-between items-center p-3 rounded border cursor-pointer transition ${isDark ? 'bg-green-900/20 border-green-800 text-green-300 hover:bg-green-900/30' : 'bg-green-50 border-green-100 text-green-900 hover:bg-green-100'}`}>
                                            <span className="font-bold">{a.label}</span>
                                            <div className="flex items-center gap-3"><Money value={getCurrentValue(a)} privacyMode={privacyMode}/><Icons.History/></div>
                                        </div>
                                    ))}
                                </div>
                                <div className="flex gap-2 items-end p-3 rounded bg-opacity-50 bg-gray-50">
                                    <div className="flex-grow"><label className={`text-xs font-bold ${mutedText}`}>Asset Name</label><input className={`w-full border p-1 rounded ${inputClass}`} value={inputs.assetName} onChange={e=>setInputs({...inputs, assetName:e.target.value})}/></div>
                                    <button onClick={()=>{ if(inputs.assetName) { setData(d => ({...d, assets: [...d.assets, {id: Date.now(), label: inputs.assetName, history: []}]})); setInputs({...inputs, assetName:''}); } }} className="bg-green-600 text-white p-2 rounded"><Icons.Plus/></button>
                                </div>
                            </div>
                            <div className={`${cardClass} p-6 rounded-xl shadow-sm border-t-4 border-red-500`}>
                                <h2 className={`text-2xl font-bold mb-4 flex justify-between ${isDark ? 'text-white' : 'text-slate-800'}`}><span>Liabilities</span><span className="text-red-600"><Money value={totalLiabilities} privacyMode={privacyMode}/></span></h2>
                                <div className="space-y-3 mb-6">
                                    {data.debts.map(d => (
                                        <div key={d.id} onClick={()=>openModal(d, 'debts')} className={`flex justify-between items-center p-3 rounded border cursor-pointer transition ${isDark ? 'bg-red-900/20 border-red-800 text-red-300 hover:bg-red-900/30' : 'bg-red-50 border-red-100 text-red-900 hover:bg-red-100'}`}>
                                            <span className="font-bold">{d.label}</span>
                                            <div className="flex items-center gap-3"><Money value={getCurrentValue(d)} privacyMode={privacyMode}/><Icons.History/></div>
                                        </div>
                                    ))}
                                </div>
                                <div className="flex gap-2 items-end p-3 rounded bg-opacity-50 bg-gray-50">
                                    <div className="flex-grow"><label className={`text-xs font-bold ${mutedText}`}>Debt Name</label><input className={`w-full border p-1 rounded ${inputClass}`} value={inputs.debtName} onChange={e=>setInputs({...inputs, debtName:e.target.value})}/></div>
                                    <button onClick={()=>{ if(inputs.debtName) { setData(d => ({...d, debts: [...d.debts, {id: generateId(inputs.debtName), label: inputs.debtName, history: []}]})); setInputs({...inputs, debtName:''}); } }} className="bg-red-600 text-white p-2 rounded"><Icons.Plus/></button>
                                </div>
                            </div>
                            <div className={`${currentTheme.bgHeader} md:col-span-2 text-white p-8 rounded-2xl text-center shadow-xl`}>
                                <h3 className="text-slate-300 uppercase tracking-widest text-sm mb-2">Total Net Worth</h3>
                                <div className="text-5xl font-extrabold flex justify-center items-center gap-4"><Money value={totalAssets - totalLiabilities} privacyMode={privacyMode}/></div>
                            </div>
                        </div>
                        {selectedItem && (
                            <div className="fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4">
                                <div className={`${cardClass} rounded-xl shadow-2xl w-full max-w-md overflow-hidden`}>
                                    <div className={`${currentTheme.bgHeader} text-white p-4 flex justify-between items-center`}>
                                        <h3 className="text-xl font-bold">{selectedItem.label} History</h3>
                                        <button onClick={()=>setSelectedItem(null)}><Icons.X/></button>
                                    </div>
                                    <div className="p-4">
                                        <div className="flex flex-col gap-2 mb-4">
                                            <label className={`text-xs font-bold ${mutedText}`}>Date</label>
                                            <input type="date" className={`border rounded px-2 py-2 w-full ${inputClass}`} value={logDate} onChange={e=>setLogDate(e.target.value)} />
                                            <label className={`text-xs font-bold ${mutedText}`}>Amount</label>
                                            <input type="number" placeholder="0.00" className={`border rounded px-2 py-2 w-full ${inputClass}`} value={logAmount} onChange={e=>setLogAmount(e.target.value)} />
                                            <button onClick={addLog} className={`${currentTheme.bgPrimary} text-white py-3 rounded font-bold w-full mt-2`}>Add Entry</button>
                                        </div>
                                        <div className="max-h-64 overflow-y-auto border-t pt-2">
                                            <table className="w-full text-sm">
                                                <thead><tr className={`text-left ${mutedText}`}><th className="p-2">Date</th><th className="p-2">Amount</th><th className="p-2"></th></tr></thead>
                                                <tbody>
                                                    {(selectedItem.history || []).sort((a,b) => b.date.localeCompare(a.date)).map((log, idx) => (
                                                        <tr key={idx} className="border-b border-gray-100 dark:border-gray-700">
                                                            <td className="p-2">{log.date}</td>
                                                            <td className="p-2 font-mono font-bold"><Money value={log.value} privacyMode={privacyMode}/></td>
                                                            <td className="p-2 text-right"><button onClick={()=>deleteLog(idx)} className="text-red-400 hover:text-red-600"><Icons.Trash/></button></td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                        <button onClick={()=>{ if(confirm("Delete permanently?")) { const type = selectedItem.type; setData(d => ({...d, [type]: d[type].filter(x => x.id !== selectedItem.id)})); setSelectedItem(null); }}} className="w-full mt-4 py-3 bg-red-50 text-red-600 rounded hover:bg-red-100 text-sm font-bold border border-red-100">Delete Item</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const renderAnalytics = () => {
                const availableYears = Object.keys(data.years).sort();
                const getFilteredMonths = () => {
                    let monthsToCalc = [];
                    if (analyticsYear === 'All Time') Object.values(data.years).forEach(y => Object.values(y).forEach(m => monthsToCalc.push(m)));
                    else {
                        const yData = data.years[analyticsYear];
                        if (yData) {
                             if (analyticsMonth === 'Whole Year') Object.values(yData).forEach(m => monthsToCalc.push(m));
                             else { const mIdx = MONTHS.indexOf(analyticsMonth); if (yData[mIdx]) monthsToCalc.push(yData[mIdx]); }
                        }
                    }
                    return monthsToCalc;
                };

                const activeMonths = getFilteredMonths();
                const totalStats = calculateStats(activeMonths);

                const categoryBreakdown = (() => {
                    let breakdown = {};
                    activeMonths.forEach(m => {
                        data.categories.fixed.forEach(group => { let groupTotal = 0; group.items.forEach(c => { groupTotal += (m.spent[c.id] || 0); }); if(groupTotal > 0) breakdown[group.label] = (breakdown[group.label] || 0) + groupTotal; });
                        const varCats = m.variableCategories || [];
                        varCats.forEach(c => { const val = getCatSpent(m, c.id) || 0; if(val > 0) breakdown[c.label] = (breakdown[c.label] || 0) + val; });
                        data.categories.savings.forEach(group => { let groupTotal = 0; group.items.forEach(c => { groupTotal += (m.spent[c.id] || 0); }); if(groupTotal > 0) breakdown[group.label] = (breakdown[group.label] || 0) + groupTotal; });
                        data.debts.forEach(d => { const val = (m.debts?.[d.id]?.payment || 0); if(val > 0) breakdown[d.label] = (breakdown[d.label] || 0) + val; });
                    });
                    return Object.entries(breakdown).sort((a,b) => b[1] - a[1]);
                })();

                const totalBreakdownSpend = categoryBreakdown.reduce((sum, x) => sum + x[1], 0);
                let accumulatedPercent = 0;
                const chartSegments = categoryBreakdown.map((cat, i) => {
                    const percent = (cat[1] / totalBreakdownSpend) * 100;
                    const segment = { ...cat, percent, start: accumulatedPercent, color: COLORS[i % COLORS.length] };
                    accumulatedPercent += percent;
                    return segment;
                });

                const income = totalStats.income || 1;
                const spentPct = Math.min((totalStats.spent / income) * 100, 100);
                const savedPct = Math.min((totalStats.saved / income) * 100, 100 - spentPct);
                const remainPct = Math.max(0, 100 - spentPct - savedPct);

                const avgMonthlySpend = totalStats.spent / Math.max(1, activeMonths.length);
                const dti = totalStats.income > 0 ? ((totalStats.debtPaid / totalStats.income) * 100).toFixed(1) : 0;
                const totalAssets = data.assets.reduce((sum, a) => sum + getCurrentValue(a), 0);
                const totalLiabilities = data.debts.reduce((sum, d) => sum + getCurrentValue(d), 0);
                const runway = avgMonthlySpend > 0 ? ((totalAssets - totalLiabilities) / avgMonthlySpend).toFixed(1) : "0.0";

                return (
                    <div className="space-y-8">
                        <div className={`${cardClass} p-4 rounded-xl shadow-sm flex flex-col md:flex-row gap-4 items-center justify-between`}>
                            <div className="flex items-center gap-2 font-bold"><Icons.Filter/> <span>Analytics Filter:</span></div>
                            <div className="flex gap-4">
                                <select className={`border p-2 rounded font-bold text-sm ${inputClass}`} value={analyticsYear} onChange={e => { setAnalyticsYear(e.target.value); setAnalyticsMonth('Whole Year'); }}><option value="All Time">All Time</option>{Object.keys(data.years).sort().map(y => <option key={y} value={y}>{y}</option>)}</select>
                                <select className={`border p-2 rounded font-bold text-sm ${inputClass}`} value={analyticsMonth} onChange={e => setAnalyticsMonth(e.target.value)} disabled={analyticsYear === 'All Time'}><option value="Whole Year">Whole Year</option>{MONTHS.map(m => <option key={m} value={m}>{m}</option>)}</select>
                            </div>
                        </div>

                        <SummaryBlock stats={totalStats} title={`${analyticsYear} - ${analyticsMonth} Summary`} theme={currentTheme} privacyMode={privacyMode} />
                        
                        <div className={`${currentTheme.bgHeader} rounded-xl p-6 grid grid-cols-2 md:grid-cols-4 gap-6 text-center text-white`}>
                            <div><p className="text-xs text-slate-400 uppercase">Avg Monthly Spend</p><p className="text-xl font-bold text-orange-400"><Money value={avgMonthlySpend} privacyMode={privacyMode}/></p></div>
                            <div><p className="text-xs text-slate-400 uppercase">Debt-to-Income</p><p className="text-xl font-bold text-red-400">{dti}%</p></div>
                            <div><p className="text-xs text-slate-400 uppercase">Total Debt Paid</p><p className="text-xl font-bold text-green-400"><Money value={totalStats.debtPaid} privacyMode={privacyMode}/></p></div>
                            <div><p className="text-xs text-slate-400 uppercase">Financial Runway</p><p className="text-xl font-bold text-blue-400">{runway} Months</p></div>
                        </div>

                        <div className="grid lg:grid-cols-2 gap-8">
                            <div className={`${cardClass} p-6 rounded-xl shadow-sm`}>
                                <h3 className={`font-bold mb-6 border-b pb-2 flex gap-2 items-center ${mutedText}`}><Icons.Chart/> Spending Breakdown</h3>
                                {chartSegments.length === 0 ? <p className="text-gray-400 italic text-center py-8">No data available.</p> : (
                                    <div className="flex flex-col md:flex-row items-center gap-8">
                                        <div className="relative w-48 h-48 flex-shrink-0">
                                            <svg viewBox="0 0 100 100" className="w-full h-full transform -rotate-90">
                                                {chartSegments.map((seg, i) => (<circle key={i} cx="50" cy="50" r="40" fill="none" stroke={seg.color} strokeWidth="20" strokeDasharray={`${(seg.percent / 100) * 251.2} 251.2`} strokeDashoffset={-((seg.start / 100) * 251.2)} className="chart-segment" />))}
                                            </svg>
                                            <div className="absolute inset-0 flex items-center justify-center flex-col"><span className={`text-xs ${mutedText}`}>Total</span><span className="font-bold"><Money value={totalBreakdownSpend} privacyMode={privacyMode}/></span></div>
                                        </div>
                                        <div className="flex-grow w-full">
                                            <div className="space-y-2">
                                                {chartSegments.map((seg, i) => (
                                                    <div key={i} className="flex justify-between text-xs items-center">
                                                        <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full" style={{background: seg.color}}></div><span>{seg[0]}</span></div>
                                                        <span className={`font-mono font-bold ${mutedText}`}><Money value={seg[1]} privacyMode={privacyMode}/> ({seg.percent.toFixed(1)}%)</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                            <div className={`${cardClass} p-6 rounded-xl shadow-sm`}>
                                <h3 className={`font-bold mb-4 ${mutedText}`}>Income Breakdown</h3>
                                <div className="h-6 bg-gray-100 rounded-full overflow-hidden flex border border-gray-200">
                                    <div className="h-full bg-red-400" style={{width: `${spentPct}%`}}></div>
                                    <div className="h-full bg-purple-400" style={{width: `${savedPct}%`}}></div>
                                    <div className="h-full bg-green-400" style={{width: `${remainPct}%`}}></div>
                                </div>
                                <div className={`flex justify-between text-xs mt-2 font-bold ${mutedText}`}>
                                    <span>Spent ({spentPct.toFixed(0)}%)</span>
                                    <span>Saved ({savedPct.toFixed(0)}%)</span>
                                    <span>Left ({remainPct.toFixed(0)}%)</span>
                                </div>
                                 <div className={`mt-8 pt-6 border-t ${isDark?'border-slate-700':'border-gray-100'}`}>
                                    <h3 className={`font-bold mb-4 ${mutedText}`}>Net Worth</h3>
                                    <div className="text-4xl font-bold text-blue-600"><Money value={totalAssets - totalLiabilities} privacyMode={privacyMode}/></div>
                                    <p className={`text-sm ${mutedText}`}>Assets - Liabilities</p>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className={`max-w-7xl mx-auto p-4 pb-20 ${textSizeClass}`}>
                    <div className="flex flex-col md:flex-row justify-between items-center mb-6">
                        <div className="flex items-center gap-3"><h1 className={`text-3xl font-extrabold tracking-tight ${currentTheme.textPrimary}`}>Financial OS <span className="text-sm font-normal text-slate-400 ml-2">v21</span></h1></div>
                        <div className="flex gap-2 mt-4 md:mt-0">
                            <button onClick={()=>setPrivacyMode(!privacyMode)} className={`p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700 transition ${privacyMode ? 'text-blue-500' : 'text-gray-400'}`}>{privacyMode ? <Icons.EyeOff/> : <Icons.Eye/>}</button>
                            <button onClick={()=>setSettingsOpen(true)} className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700 transition text-gray-400"><Icons.Gear/></button>
                            {user && <button onClick={logout} className="bg-white border text-red-500 px-3 py-1.5 rounded text-sm flex gap-2 hover:bg-gray-50"><Icons.LogOut/> Sign Out</button>}
                        </div>
                    </div>
                    {settingsOpen && renderSettings()}
                    <div className={`flex gap-1 p-1 rounded-lg shadow-sm mb-6 overflow-x-auto ${cardClass}`}>{['budget', 'net worth', 'analytics', 'strategy'].map(t => (<button key={t} onClick={()=>setActiveTab(t)} className={`px-4 py-2 rounded-md font-bold capitalize whitespace-nowrap transition-colors ${activeTab===t ? `${currentTheme.bgPrimary} text-white` : `hover:bg-opacity-10 ${currentTheme.textPrimary}`}`}>{t}</button>))}</div>
                    <div className="min-h-screen">
                        {activeTab === 'budget' && renderBudget()}
                        {activeTab === 'net worth' && renderNetWorth()}
                        {activeTab === 'analytics' && renderAnalytics()}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FinancialOS />);
    </script>
</body>
</html>
