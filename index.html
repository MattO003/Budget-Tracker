<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial OS v17 (Grouped Expenses)</title>
    
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            alert("Error: " + message + "\nLine: " + lineno);
        };
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        .progress-bar { transition: width 0.5s ease-in-out; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .chart-segment { transition: stroke-width 0.2s; cursor: pointer; }
        .chart-segment:hover { stroke-width: 25; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 text-slate-800 font-sans">
    <div id="root"></div>
    
    <script type="text/babel">
        // --- FIREBASE CONFIGURATION ---
        // PASTE YOUR KEYS HERE
        const firebaseConfig = {
            apiKey: "PASTE_API_KEY_HERE",
            authDomain: "PASTE_AUTH_DOMAIN_HERE",
            projectId: "PASTE_PROJECT_ID_HERE",
            storageBucket: "PASTE_BUCKET_HERE",
            messagingSenderId: "PASTE_SENDER_ID",
            appId: "PASTE_APP_ID"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        const { useState, useEffect, useRef, useMemo } = React;

        // --- ICONS ---
        const Icons = {
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
            ChevronDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>,
            ChevronUp: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>,
            Calendar: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
            Chart: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>,
            LogOut: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>,
            Filter: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>,
            Bolt: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
        };

        const MONTHS = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const COLORS = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6', '#f97316', '#64748b'];

        const generateId = (name) => name.toLowerCase().replace(/[^a-z0-9]/g, '') + '_' + Date.now();
        const getEmptyYear = () => {
            const y = {};
            for (let i = 0; i < 12; i++) y[i] = { income: [], expenses: {}, spent: {}, transactions: {}, debts: {} };
            return y;
        };

        // NEW: Grouped Data Structure
        const DEFAULT_DATA = {
            categories: {
                fixed: [
                    { id: 'housing', label: 'Housing', items: [{id: 'rent', label: 'Rent'}, {id: 'trash', label: 'Trash'}] },
                    { id: 'insurance', label: 'Insurance', items: [{id: 'car_ins', label: 'Car Insurance'}] }
                ],
                variable: [{ id: 'groceries', label: 'Groceries' }, { id: 'gas', label: 'Gas' }],
                savings: [
                    { id: 'buckets', label: 'Buckets', items: [{id: 'roth', label: 'Roth IRA'}] }
                ]
            },
            assets: [], debts: [], savingsGoals: [],
            years: { [new Date().getFullYear()]: getEmptyYear() }
        };

        // --- SHARED COMPONENT ---
        const SummaryBlock = ({ stats, title, colorClass = "bg-slate-900" }) => (
            <div className={`${colorClass} text-white p-6 rounded-xl mt-4 shadow-lg border border-slate-700`}>
                <h3 className="font-bold text-slate-200 border-b border-slate-600 pb-2 mb-4 text-lg">{title}</h3>
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-6 text-center">
                    <div><p className="text-xs text-slate-400 uppercase tracking-wider">Total Income</p><p className="text-xl font-bold text-green-400">${stats.income.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p></div>
                    <div><p className="text-xs text-slate-400 uppercase tracking-wider">Total Budgeted</p><p className="text-xl font-bold text-blue-400">${stats.budgeted.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p></div>
                    <div><p className="text-xs text-slate-400 uppercase tracking-wider">Total Spent</p><p className="text-xl font-bold text-red-400">${stats.spent.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p></div>
                    <div><p className="text-xs text-slate-400 uppercase tracking-wider">Remaining Cash</p><p className={`text-xl font-bold ${stats.remaining>=0?'text-green-400':'text-red-400'}`}>${stats.remaining.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p></div>
                    <div><p className="text-xs text-slate-400 uppercase tracking-wider">Proj. Savings</p><p className="text-xl font-bold text-purple-400">${stats.saved.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p></div>
                    <div><p className="text-xs text-slate-400 uppercase tracking-wider">Savings Rate</p><p className="text-xl font-bold text-purple-400">{stats.rate}%</p></div>
                </div>
            </div>
        );

        const FinancialOS = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [data, setData] = useState(null);
            const [activeTab, setActiveTab] = useState('budget');
            
            const [expandedYears, setExpandedYears] = useState([new Date().getFullYear().toString()]);
            const [expandedMonths, setExpandedMonths] = useState({});
            const [activeTransactionCategory, setActiveTransactionCategory] = useState(null);
            const [analyticsYear, setAnalyticsYear] = useState('All Time');
            const [analyticsMonth, setAnalyticsMonth] = useState('Whole Year');

            // NEW INPUTS for Groups
            const [inputs, setInputs] = useState({ year: '', cat: '', itemDesc: '', itemAmt: '', assetName: '', assetVal: '', debtName: '', debtBal: '', debtRate: '', goalName: '', goalTarget: '', incName: '', incAmt: '', varCat: '', saveCat: '', newGroup: '', newItem: '', targetGroup: '' });
            const [debtSimExtra, setDebtSimExtra] = useState(0);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(u => {
                    if (u) setUser(u);
                    else { setUser(null); setData(null); setLoading(false); }
                });
                return unsubscribe;
            }, []);

            useEffect(() => {
                if (user) {
                    setLoading(true);
                    const docRef = db.collection('users').doc(user.uid);
                    const unsubscribe = docRef.onSnapshot(doc => {
                        if (doc.exists) {
                            let fetchedData = doc.data();
                            
                            // --- AUTO-MIGRATION: Convert Old Flat List to New Groups ---
                            let needsUpdate = false;
                            if (fetchedData.categories.fixed.length > 0 && !fetchedData.categories.fixed[0].items) {
                                fetchedData.categories.fixed = [{ id: 'general_fixed', label: 'General Fixed Expenses', items: fetchedData.categories.fixed }];
                                needsUpdate = true;
                            }
                            if (fetchedData.categories.savings.length > 0 && !fetchedData.categories.savings[0].items) {
                                fetchedData.categories.savings = [{ id: 'general_savings', label: 'General Savings', items: fetchedData.categories.savings }];
                                needsUpdate = true;
                            }
                            
                            setData(fetchedData);
                            if(needsUpdate) docRef.set(fetchedData); // Save the migrated structure
                        } else {
                            docRef.set(DEFAULT_DATA);
                            setData(DEFAULT_DATA);
                        }
                        setLoading(false);
                    }, (err) => setLoading(false));
                    return unsubscribe;
                }
            }, [user]);

            useEffect(() => {
                if (user && data && !loading) {
                    const timer = setTimeout(() => db.collection('users').doc(user.uid).set(data), 1000);
                    return () => clearTimeout(timer);
                }
            }, [data, user, loading]);

            const login = () => auth.signInWithPopup(googleProvider).catch(e => alert(e.message));
            const logout = () => { auth.signOut(); setUser(null); setData(null); };

            // --- CALCS ---
            const getCatSpent = (m, catId) => m.transactions?.[catId]?.reduce((s, t) => s + t.amount, 0) || 0;
            const getMonthIncome = (m) => m.income.reduce((s, i) => s + i.amount, 0);

            const calculateStats = (monthsArray) => {
                if (!data) return { income: 0, budgeted: 0, spent: 0, saved: 0, debtPaid: 0, remaining: 0, rate: 0 };
                let s = { income: 0, budgeted: 0, spent: 0, saved: 0, debtPaid: 0 };
                
                monthsArray.forEach(m => {
                    s.income += getMonthIncome(m);
                    // Fixed (Nested)
                    data.categories.fixed.forEach(group => {
                        group.items.forEach(c => {
                            s.budgeted += (m.expenses[c.id] || 0);
                            s.spent += (m.spent[c.id] || 0);
                        });
                    });
                    // Variable (Flat)
                    data.categories.variable.forEach(c => {
                        s.budgeted += (m.expenses[c.id] || 0);
                        s.spent += getCatSpent(m, c.id);
                    });
                    // Savings (Nested)
                    data.categories.savings.forEach(group => {
                        group.items.forEach(c => {
                            s.budgeted += (m.expenses[c.id] || 0);
                            s.saved += (m.spent[c.id] || 0);
                        });
                    });
                    // Debt
                    data.debts.forEach(d => {
                        s.debtPaid += (m.debts?.[d.id]?.payment || 0);
                        s.spent += (m.debts?.[d.id]?.payment || 0);
                    });
                });
                s.remaining = s.income - (s.spent + s.saved);
                s.rate = s.income > 0 ? ((s.saved / s.income) * 100).toFixed(1) : "0.0";
                return s;
            };

            const updateMonth = (y, mIdx, cb) => setData(d => ({ ...d, years: { ...d.years, [y]: { ...d.years[y], [mIdx]: cb(d.years[y][mIdx]) } } }));
            
            // GROUP ACTIONS
            const addGroup = (type, name) => {
                if(!name) return;
                const id = generateId(name);
                setData(d => ({...d, categories: {...d.categories, [type]: [...d.categories[type], {id, label: name, items: []}]}}));
                setInputs(prev => ({...prev, newGroup: ''}));
            };

            const deleteGroup = (type, groupId) => {
                if(confirm("Delete entire group and all items inside?")) {
                    setData(d => ({...d, categories: {...d.categories, [type]: d.categories[type].filter(g => g.id !== groupId)}}));
                }
            };

            const addItemToGroup = (type, groupId, name) => {
                if(!name) return;
                const id = generateId(name);
                setData(d => ({
                    ...d, 
                    categories: {
                        ...d.categories, 
                        [type]: d.categories[type].map(g => g.id === groupId ? {...g, items: [...g.items, {id, label: name}]} : g)
                    }
                }));
                setInputs(prev => ({...prev, newItem: '', targetGroup: ''}));
            };

            const deleteItemFromGroup = (type, groupId, itemId) => {
                if(confirm("Delete item?")) {
                    setData(d => ({
                        ...d, 
                        categories: {
                            ...d.categories, 
                            [type]: d.categories[type].map(g => g.id === groupId ? {...g, items: g.items.filter(i => i.id !== itemId)} : g)
                        }
                    }));
                }
            };

            // Legacy Add for Variable (Flat)
            const addCategory = (type, name) => {
                if(!name) return;
                const id = generateId(name);
                setData(d => ({...d, categories: {...d.categories, [type]: [...(d.categories[type]||[]), {id, label: name}]}}));
                setInputs(prev => ({...prev, varCat: ''}));
            };
            const deleteCategory = (type, id) => {
                if(confirm("Delete category?")) setData(d => ({...d, categories: {...d.categories, [type]: d.categories[type].filter(c => c.id !== id)}}));
            };
            
            const deleteYear = (year) => {
                if(confirm(`Delete ${year}?`)) {
                    setData(d => { const newYears = { ...d.years }; delete newYears[year]; return { ...d, years: newYears }; });
                }
            };

            const autofillBudget = (year, sourceMonthIdx) => {
                if(!confirm(`Copy budget values from ${MONTHS[sourceMonthIdx]} to ALL other months in ${year}?`)) return;
                const sourceExpenses = data.years[year][sourceMonthIdx].expenses;
                setData(d => {
                    const updatedYear = { ...d.years[year] };
                    for (let i = 0; i < 12; i++) {
                        if (i !== sourceMonthIdx) {
                            updatedYear[i] = { ...updatedYear[i], expenses: { ...sourceExpenses } };
                        }
                    }
                    return { ...d, years: { ...d.years, [year]: updatedYear } };
                });
            };

            // --- VIEWS ---
            if (loading || (user && !data)) return <div className="h-screen flex items-center justify-center bg-gray-100 flex-col"><div className="loader mb-4"></div><p className="text-slate-500 font-bold animate-pulse">Loading Profile...</p></div>;

            if (!user) {
                return (
                    <div className="h-screen flex flex-col items-center justify-center bg-gray-100 p-4">
                        <div className="bg-white p-8 rounded-xl shadow-lg max-w-md w-full text-center">
                            <h1 className="text-3xl font-extrabold text-slate-800 mb-2">Financial OS</h1>
                            <p className="text-gray-500 mb-8">Secure, Multi-Year Budget Tracking</p>
                            <button onClick={login} className="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg w-full hover:bg-blue-700 transition flex items-center justify-center gap-2"><svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12.545 10.239v3.821h5.445c-0.712 2.315-2.647 3.972-5.445 3.972-3.332 0-6.033-2.531-6.033-5.652s2.701-5.652 6.033-5.652c1.498 0 2.866 0.549 3.921 1.453l2.814-2.814c-1.79-1.677-4.184-2.702-6.735-2.702-5.522 0-10 4.478-10 10s4.478 10 10 10c8.396 0 10.249-7.85 9.426-11.748l-9.426-0.001z"/></svg> Sign In with Google</button>
                        </div>
                    </div>
                );
            }

            const renderBudget = () => {
                return (
                    <div className="space-y-6">
                        {Object.keys(data.years).sort().map(year => {
                            const yearStats = calculateStats(Object.values(data.years[year]));
                            return (
                                <div key={year} className="border rounded-xl bg-white shadow-sm overflow-hidden">
                                    <div onClick={() => setExpandedYears(prev => prev.includes(year) ? prev.filter(y=>y!==year) : [...prev, year])} 
                                         className="bg-slate-800 text-white p-4 flex justify-between items-center cursor-pointer hover:bg-slate-700">
                                        <div className="flex items-center gap-4">
                                            <h2 className="text-xl font-bold flex gap-2"><Icons.Calendar/> {year}</h2>
                                            <button onClick={(e) => { e.stopPropagation(); deleteYear(year); }} className="text-slate-400 hover:text-red-400 p-1"><Icons.Trash /></button>
                                        </div>
                                        {expandedYears.includes(year) ? <Icons.ChevronUp/> : <Icons.ChevronDown/>}
                                    </div>
                                    {expandedYears.includes(year) && (
                                        <div className="p-4 grid gap-4">
                                            {MONTHS.map((monthName, mIdx) => {
                                                const mData = data.years[year][mIdx];
                                                const isExpanded = (expandedMonths[year] || []).includes(mIdx);
                                                const mStats = calculateStats([mData]);

                                                return (
                                                    <div key={mIdx} className={`border rounded-lg ${isExpanded ? 'ring-2 ring-blue-100' : ''}`}>
                                                        <div onClick={() => setExpandedMonths(prev => ({...prev, [year]: prev[year]?.includes(mIdx) ? prev[year].filter(m=>m!==mIdx) : [...(prev[year]||[]), mIdx]}))}
                                                             className="p-3 flex justify-between items-center bg-gray-50 cursor-pointer hover:bg-gray-100">
                                                            <span className="font-bold text-gray-700 w-24">{monthName}</span>
                                                            <div className="flex gap-4 text-sm text-gray-500 hidden md:flex">
                                                                <span>In: <b className="text-green-600">${Number(mStats.income).toFixed(0)}</b></span>
                                                                <span>Out: <b className="text-red-600">${Number(mStats.spent).toFixed(0)}</b></span>
                                                                <span>Rem: <b className={mStats.remaining >= 0 ? 'text-green-600' : 'text-red-600'}>${Number(mStats.remaining).toFixed(0)}</b></span>
                                                            </div>
                                                            {isExpanded ? <Icons.ChevronUp/> : <Icons.ChevronDown/>}
                                                        </div>

                                                        {isExpanded && (
                                                            <div className="p-4 bg-white">
                                                                <div className="flex justify-end mb-4">
                                                                    <button onClick={()=>autofillBudget(year, mIdx)} className="text-xs flex items-center gap-1 bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 transition">
                                                                        <Icons.Bolt/> Apply to All Months
                                                                    </button>
                                                                </div>
                                                                <div className="grid lg:grid-cols-2 gap-6 mb-6">
                                                                    <div className="space-y-6">
                                                                        <div className="bg-green-50 p-3 rounded border border-green-100">
                                                                            <h4 className="text-xs font-bold text-green-800 uppercase mb-2">Income Sources</h4>
                                                                            {mData.income.map((inc, idx) => (
                                                                                <div key={idx} className="flex justify-between text-sm mb-1">
                                                                                    <span>{inc.label}</span>
                                                                                    <span className="font-mono">${inc.amount}</span>
                                                                                    <button onClick={()=>updateMonth(year, mIdx, m => ({...m, income: m.income.filter((_,i)=>i!==idx)}))} className="text-red-400"><Icons.Trash/></button>
                                                                                </div>
                                                                            ))}
                                                                            <div className="flex gap-1 mt-2">
                                                                                <input placeholder="Source" className="w-full text-xs border rounded px-1" value={inputs.incName} onChange={e=>setInputs({...inputs, incName: e.target.value})} />
                                                                                <input placeholder="$" type="number" className="w-16 text-xs border rounded px-1" value={inputs.incAmt} onChange={e=>setInputs({...inputs, incAmt: e.target.value})} />
                                                                                <button onClick={()=>{
                                                                                    if(inputs.incName && inputs.incAmt) {
                                                                                        updateMonth(year, mIdx, m => ({...m, income: [...m.income, {label: inputs.incName, amount: parseFloat(inputs.incAmt)}]}));
                                                                                        setInputs({...inputs, incName: '', incAmt: ''});
                                                                                    }
                                                                                }} className="bg-green-600 text-white rounded px-1"><Icons.Plus/></button>
                                                                            </div>
                                                                        </div>

                                                                        <div>
                                                                            <h4 className="font-bold text-sm text-gray-600 border-b mb-4">Fixed Expenses</h4>
                                                                            {data.categories.fixed.map(group => (
                                                                                <div key={group.id} className="mb-4 border rounded p-2 bg-gray-50">
                                                                                    <div className="flex justify-between items-center mb-2 border-b pb-1">
                                                                                        <span className="font-bold text-xs text-gray-700 uppercase tracking-wider">{group.label}</span>
                                                                                        <button onClick={()=>deleteGroup('fixed', group.id)} className="text-gray-300 hover:text-red-400"><Icons.Trash/></button>
                                                                                    </div>
                                                                                    <div className="space-y-1">
                                                                                        {group.items.map(c => (
                                                                                            <div key={c.id} className="flex justify-between items-center text-xs pl-2">
                                                                                                <span className="flex items-center gap-1 group">{c.label} <button onClick={()=>deleteItemFromGroup('fixed', group.id, c.id)} className="opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-400"><Icons.Trash/></button></span>
                                                                                                <div className="flex gap-1">
                                                                                                    <input type="number" className="w-16 border rounded px-1" value={mData.expenses[c.id]||''} placeholder="Bud" onChange={e=>updateMonth(year, mIdx, m => ({...m, expenses: {...m.expenses, [c.id]: parseFloat(e.target.value)||0}}))} />
                                                                                                    <input type="number" className="w-16 border rounded px-1" value={mData.spent[c.id]||''} placeholder="Pay" onChange={e=>updateMonth(year, mIdx, m => ({...m, spent: {...m.spent, [c.id]: parseFloat(e.target.value)||0}}))} />
                                                                                                </div>
                                                                                            </div>
                                                                                        ))}
                                                                                        <div className="flex gap-1 mt-1 pl-2">
                                                                                            <input placeholder="New Item" className="w-full text-[10px] border rounded px-1" value={inputs.targetGroup === group.id ? inputs.newItem : ''} onChange={e=>setInputs({...inputs, newItem: e.target.value, targetGroup: group.id})}/>
                                                                                            <button onClick={()=>{ if(inputs.targetGroup === group.id) addItemToGroup('fixed', group.id, inputs.newItem); }} className="bg-gray-200 rounded px-1 text-[10px]"><Icons.Plus/></button>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            ))}
                                                                            <div className="flex gap-1 mt-4">
                                                                                <input placeholder="New Fixed Group" className="w-full text-xs border rounded px-1 font-bold" value={inputs.newGroup} onChange={e=>setInputs({...inputs, newGroup: e.target.value})}/>
                                                                                <button onClick={()=>addGroup('fixed', inputs.newGroup)} className="bg-slate-700 text-white rounded px-2 text-xs">Add Group</button>
                                                                            </div>
                                                                        </div>
                                                                    </div>

                                                                    <div className="space-y-6">
                                                                        <div className="bg-purple-50 p-3 rounded border border-purple-100">
                                                                            <h4 className="text-xs font-bold text-purple-800 uppercase mb-4">Savings Buckets</h4>
                                                                            {data.categories.savings.map(group => (
                                                                                <div key={group.id} className="mb-4 border border-purple-200 rounded p-2 bg-purple-50/50">
                                                                                    <div className="flex justify-between items-center mb-2 border-b border-purple-200 pb-1">
                                                                                        <span className="font-bold text-xs text-purple-700 uppercase tracking-wider">{group.label}</span>
                                                                                        <button onClick={()=>deleteGroup('savings', group.id)} className="text-purple-300 hover:text-red-400"><Icons.Trash/></button>
                                                                                    </div>
                                                                                    <div className="space-y-1">
                                                                                        {group.items.map(c => (
                                                                                            <div key={c.id} className="flex justify-between items-center text-xs pl-2">
                                                                                                <span className="flex items-center gap-1 group text-purple-900">{c.label} <button onClick={()=>deleteItemFromGroup('savings', group.id, c.id)} className="opacity-0 group-hover:opacity-100 text-purple-300 hover:text-red-400"><Icons.Trash/></button></span>
                                                                                                <div className="flex gap-1">
                                                                                                    <input type="number" className="w-16 border rounded px-1" value={mData.expenses[c.id]||''} placeholder="Goal" onChange={e=>updateMonth(year, mIdx, m => ({...m, expenses: {...m.expenses, [c.id]: parseFloat(e.target.value)||0}}))} />
                                                                                                    <input type="number" className="w-16 border rounded px-1" value={mData.spent[c.id]||''} placeholder="Saved" onChange={e=>updateMonth(year, mIdx, m => ({...m, spent: {...m.spent, [c.id]: parseFloat(e.target.value)||0}}))} />
                                                                                                </div>
                                                                                            </div>
                                                                                        ))}
                                                                                        <div className="flex gap-1 mt-1 pl-2">
                                                                                            <input placeholder="New Bucket" className="w-full text-[10px] border rounded px-1" value={inputs.targetGroup === group.id ? inputs.newItem : ''} onChange={e=>setInputs({...inputs, newItem: e.target.value, targetGroup: group.id})}/>
                                                                                            <button onClick={()=>{ if(inputs.targetGroup === group.id) addItemToGroup('savings', group.id, inputs.newItem); }} className="bg-purple-200 text-purple-800 rounded px-1 text-[10px]"><Icons.Plus/></button>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            ))}
                                                                            <div className="flex gap-1 mt-4">
                                                                                <input placeholder="New Savings Group" className="w-full text-xs border rounded px-1 font-bold" value={inputs.saveCat} onChange={e=>setInputs({...inputs, saveCat: e.target.value})}/>
                                                                                <button onClick={()=>{ addGroup('savings', inputs.saveCat); setInputs({...inputs, saveCat: ''}) }} className="bg-purple-600 text-white rounded px-2 text-xs">Add Group</button>
                                                                            </div>
                                                                        </div>

                                                                        <div>
                                                                            <h4 className="font-bold text-sm text-gray-600 border-b mb-2">Variable Expenses</h4>
                                                                            <div className="space-y-2">
                                                                                {data.categories.variable.map(c => {
                                                                                    const spent = getCatSpent(mData, c.id);
                                                                                    const bud = mData.expenses[c.id] || 0;
                                                                                    const remaining = bud - spent;
                                                                                    const isOpen = activeTransactionCategory?.year === year && activeTransactionCategory?.month === mIdx && activeTransactionCategory?.cat === c.id;
                                                                                    
                                                                                    return (
                                                                                        <div key={c.id} className="text-xs border rounded bg-gray-50 p-2">
                                                                                            <div className="flex justify-between items-center mb-1">
                                                                                                <div className="flex gap-1 items-center">
                                                                                                    <span onClick={()=>setActiveTransactionCategory(isOpen ? null : {year, month: mIdx, cat: c.id})} className="font-bold cursor-pointer text-blue-600 hover:underline">{c.label}</span>
                                                                                                    <button onClick={()=>deleteCategory('variable', c.id)} className="text-gray-300 hover:text-red-400"><Icons.Trash/></button>
                                                                                                </div>
                                                                                                <div className="flex gap-2 items-center">
                                                                                                    <input type="number" className="w-16 border rounded px-1 h-6 text-right" value={mData.expenses[c.id]||''} placeholder="Bud" onChange={e=>updateMonth(year, mIdx, m => ({...m, expenses: {...m.expenses, [c.id]: parseFloat(e.target.value)||0}}))} />
                                                                                                    <div className="flex flex-col items-end w-16">
                                                                                                        <span className="text-[10px] text-gray-500">Spent: ${Number(spent).toFixed(2)}</span>
                                                                                                        <span className={`text-[10px] font-bold ${remaining < 0 ? 'text-red-500' : 'text-green-600'}`}>Left: ${Number(remaining).toFixed(2)}</span>
                                                                                                    </div>
                                                                                                </div>
                                                                                            </div>
                                                                                            {isOpen && (
                                                                                                <div className="bg-white p-2 mt-1 border-t">
                                                                                                    <div className="flex gap-1 mb-2">
                                                                                                        <input placeholder="Item" className="border rounded w-full px-1" value={inputs.itemDesc} onChange={e=>setInputs({...inputs, itemDesc: e.target.value})} />
                                                                                                        <input type="number" placeholder="$" className="border rounded w-12 px-1" value={inputs.itemAmt} onChange={e=>setInputs({...inputs, itemAmt: e.target.value})} />
                                                                                                        <button onClick={()=>{
                                                                                                            if(inputs.itemDesc && inputs.itemAmt){
                                                                                                                const t = {id: Date.now(), desc: inputs.itemDesc, amount: parseFloat(inputs.itemAmt)};
                                                                                                                updateMonth(year, mIdx, m => ({...m, transactions: {...m.transactions, [c.id]: [...(m.transactions[c.id]||[]), t]}}));
                                                                                                                setInputs({...inputs, itemDesc:'', itemAmt:''});
                                                                                                            }
                                                                                                        }} className="bg-green-500 text-white rounded px-1"><Icons.Plus/></button>
                                                                                                    </div>
                                                                                                    {mData.transactions[c.id]?.map(t => (
                                                                                                        <div key={t.id} className="flex justify-between border-b py-1">
                                                                                                            <span>{t.desc}</span>
                                                                                                            <div className="flex gap-2"><span>${t.amount}</span><button onClick={()=>updateMonth(year, mIdx, m => ({...m, transactions: {...m.transactions, [c.id]: m.transactions[c.id].filter(x=>x.id!==t.id)}}))} className="text-red-400"><Icons.Trash/></button></div>
                                                                                                        </div>
                                                                                                    ))}
                                                                                                </div>
                                                                                            )}
                                                                                        </div>
                                                                                    )
                                                                                })}
                                                                                <div className="pt-2 flex gap-1">
                                                                                     <input placeholder="New Variable Cat" className="w-full text-xs border rounded px-1" value={inputs.varCat} onChange={e=>setInputs({...inputs, varCat:e.target.value})}/>
                                                                                     <button onClick={()=>addCategory('variable', inputs.varCat)} className="bg-gray-200 rounded px-2"><Icons.Plus/></button>
                                                                                </div>
                                                                            </div>
                                                                        </div>

                                                                        <div className="bg-red-50 p-3 rounded border border-red-100">
                                                                            <h4 className="text-xs font-bold text-red-800 uppercase mb-2">Debt Payments</h4>
                                                                            {data.debts.map(d => (
                                                                                <div key={d.id} className="flex justify-between items-center text-xs mb-1">
                                                                                    <span>{d.label}</span>
                                                                                    <input type="number" placeholder="Paid" className="w-16 border border-red-200 rounded px-1" 
                                                                                           value={mData.debts?.[d.id]?.payment || ''}
                                                                                           onChange={e=>updateMonth(year, mIdx, m => ({...m, debts: {...m.debts, [d.id]: {...(m.debts?.[d.id]||{}), payment: parseFloat(e.target.value)||0}}}))} />
                                                                                </div>
                                                                            ))}
                                                                            {data.debts.length===0 && <span className="text-xs text-gray-400 italic">Add debts in Net Worth tab</span>}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <SummaryBlock stats={mStats} title={`${monthName} Summary`} />
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                            <SummaryBlock stats={yearStats} title={`${year} Annual Summary`} colorClass="bg-slate-800" />
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                        <div className="flex justify-center gap-2">
                            <input type="number" placeholder="YYYY" className="border px-2 py-1 rounded w-24" id="newYearInput" />
                            <button onClick={()=>{
                                const y = document.getElementById('newYearInput').value;
                                if(y && !data.years[y]) setData(d => ({...d, years: {...d.years, [y]: getEmptyYear()}}));
                            }} className="bg-slate-800 text-white px-4 py-1 rounded">Add Year</button>
                        </div>
                    </div>
                );
            };

            const renderNetWorth = () => {
                const totalAssets = data.assets.reduce((sum, a) => sum + a.value, 0);
                const totalLiabilities = data.debts.reduce((sum, d) => sum + d.balance, 0);

                return (
                    <div className="grid md:grid-cols-2 gap-8">
                        <div className="bg-white p-6 rounded-xl shadow-sm border-t-4 border-green-500">
                            <h2 className="text-2xl font-bold text-slate-800 mb-4 flex justify-between">
                                <span>Assets</span>
                                <span className="text-green-600">${totalAssets.toLocaleString()}</span>
                            </h2>
                            <div className="space-y-3 mb-6">
                                {data.assets.map(a => (
                                    <div key={a.id} className="flex justify-between items-center p-3 bg-green-50 rounded border border-green-100">
                                        <span className="font-bold text-green-900">{a.label}</span>
                                        <div className="flex items-center gap-3">
                                            <span className="font-mono">${a.value.toLocaleString()}</span>
                                            <button onClick={()=>setData(prev=>({...prev, assets: prev.assets.filter(x=>x.id!==a.id)}))} className="text-green-400 hover:text-green-700"><Icons.Trash/></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <div className="flex gap-2 items-end bg-gray-50 p-3 rounded">
                                <div className="flex-grow"><label className="text-xs font-bold text-gray-400">Asset Name</label><input className="w-full border p-1 rounded" value={inputs.assetName} onChange={e=>setInputs({...inputs, assetName:e.target.value})}/></div>
                                <div className="w-24"><label className="text-xs font-bold text-gray-400">Value</label><input type="number" className="w-full border p-1 rounded" value={inputs.assetVal} onChange={e=>setInputs({...inputs, assetVal:e.target.value})}/></div>
                                <button onClick={()=>{
                                    if(inputs.assetName && inputs.assetVal) {
                                        setData(d => ({...d, assets: [...d.assets, {id: Date.now(), label: inputs.assetName, value: parseFloat(inputs.assetVal), type: 'Asset'}]}));
                                        setInputs({...inputs, assetName:'', assetVal:''});
                                    }
                                }} className="bg-green-600 text-white p-2 rounded"><Icons.Plus/></button>
                            </div>
                        </div>

                        <div className="bg-white p-6 rounded-xl shadow-sm border-t-4 border-red-500">
                            <h2 className="text-2xl font-bold text-slate-800 mb-4 flex justify-between">
                                <span>Liabilities</span>
                                <span className="text-red-600">${totalLiabilities.toLocaleString()}</span>
                            </h2>
                            <div className="space-y-3 mb-6">
                                {data.debts.map(d => (
                                    <div key={d.id} className="flex justify-between items-center p-3 bg-red-50 rounded border border-red-100">
                                        <span className="font-bold text-red-900">{d.label} <span className="text-xs font-normal text-red-700 bg-red-200 px-1 rounded ml-2">{d.rate}% APR</span></span>
                                        <div className="flex items-center gap-3">
                                            <span className="font-mono">${d.balance.toLocaleString()}</span>
                                            <button onClick={()=>setData(prev=>({...prev, debts: prev.debts.filter(x=>x.id!==d.id)}))} className="text-red-400 hover:text-red-700"><Icons.Trash/></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <div className="flex gap-2 items-end bg-gray-50 p-3 rounded">
                                <div className="flex-grow"><label className="text-xs font-bold text-gray-400">Debt Name</label><input className="w-full border p-1 rounded" value={inputs.debtName} onChange={e=>setInputs({...inputs, debtName:e.target.value})}/></div>
                                <div className="w-24"><label className="text-xs font-bold text-gray-400">Balance</label><input type="number" className="w-full border p-1 rounded" value={inputs.debtBal} onChange={e=>setInputs({...inputs, debtBal:e.target.value})}/></div>
                                <div className="w-16"><label className="text-xs font-bold text-gray-400">APR %</label><input type="number" className="w-full border p-1 rounded" value={inputs.debtRate} onChange={e=>setInputs({...inputs, debtRate:e.target.value})}/></div>
                                <button onClick={()=>{
                                    if(inputs.debtName && inputs.debtBal) {
                                        setData(d => ({...d, debts: [...d.debts, {id: generateId(inputs.debtName), label: inputs.debtName, balance: parseFloat(inputs.debtBal), rate: parseFloat(inputs.debtRate)||0}]}));
                                        setInputs({...inputs, debtName:'', debtBal:'', debtRate:''});
                                    }
                                }} className="bg-red-600 text-white p-2 rounded"><Icons.Plus/></button>
                            </div>
                        </div>

                        <div className="md:col-span-2 bg-slate-900 text-white p-8 rounded-2xl text-center shadow-xl">
                            <h3 className="text-gray-400 uppercase tracking-widest text-sm mb-2">Total Net Worth</h3>
                            <div className="text-5xl font-extrabold flex justify-center items-center gap-4">
                                ${(totalAssets - totalLiabilities).toLocaleString()}
                            </div>
                        </div>
                    </div>
                );
            };

            const renderAnalytics = () => {
                const availableYears = Object.keys(data.years).sort();
                
                const getFilteredMonths = () => {
                    let monthsToCalc = [];
                    if (analyticsYear === 'All Time') {
                         Object.values(data.years).forEach(y => Object.values(y).forEach(m => monthsToCalc.push(m)));
                    } else {
                        const yData = data.years[analyticsYear];
                        if (yData) {
                             if (analyticsMonth === 'Whole Year') {
                                 Object.values(yData).forEach(m => monthsToCalc.push(m));
                             } else {
                                 const mIdx = MONTHS.indexOf(analyticsMonth);
                                 if (yData[mIdx]) monthsToCalc.push(yData[mIdx]);
                             }
                        }
                    }
                    return monthsToCalc;
                };

                const activeMonths = getFilteredMonths();
                const totalStats = calculateStats(activeMonths);

                // UPDATE: Aggregate by GROUPS for Chart
                const categoryBreakdown = (() => {
                    let breakdown = {};
                    activeMonths.forEach(m => {
                        // Fixed: Group Total
                        data.categories.fixed.forEach(group => {
                            let groupTotal = 0;
                            group.items.forEach(c => {
                                groupTotal += (m.spent[c.id] || m.expenses[c.id] || 0);
                            });
                            if(groupTotal > 0) breakdown[group.label] = (breakdown[group.label] || 0) + groupTotal;
                        });
                        // Variable: Individual Items (Flat)
                        data.categories.variable.forEach(c => {
                            const val = getCatSpent(m, c.id) || m.expenses[c.id] || 0; 
                            if(val > 0) breakdown[c.label] = (breakdown[c.label] || 0) + val;
                        });
                        // Savings: Group Total
                        data.categories.savings.forEach(group => {
                            let groupTotal = 0;
                            group.items.forEach(c => {
                                groupTotal += (m.spent[c.id] || m.expenses[c.id] || 0);
                            });
                            if(groupTotal > 0) breakdown[group.label] = (breakdown[group.label] || 0) + groupTotal;
                        });
                        // Debt
                        data.debts.forEach(d => {
                            const val = (m.debts?.[d.id]?.payment || 0);
                            if(val > 0) breakdown[d.label] = (breakdown[d.label] || 0) + val;
                        });
                    });
                    return Object.entries(breakdown).sort((a,b) => b[1] - a[1]);
                })();

                const totalBreakdownSpend = categoryBreakdown.reduce((sum, x) => sum + x[1], 0);
                let accumulatedPercent = 0;
                const chartSegments = categoryBreakdown.map((cat, i) => {
                    const percent = (cat[1] / totalBreakdownSpend) * 100;
                    const segment = { ...cat, percent, start: accumulatedPercent, color: COLORS[i % COLORS.length] };
                    accumulatedPercent += percent;
                    return segment;
                });

                const income = totalStats.income || 1;
                const spentPct = Math.min((totalStats.spent / income) * 100, 100);
                const savedPct = Math.min((totalStats.saved / income) * 100, 100 - spentPct);
                const remainPct = Math.max(0, 100 - spentPct - savedPct);

                const monthCount = Math.max(1, activeMonths.length);
                const avgMonthlySpend = totalStats.spent / monthCount;
                const dti = totalStats.income > 0 ? ((totalStats.debtPaid / totalStats.income) * 100).toFixed(1) : 0;
                const totalAssets = data.assets.reduce((sum, a) => sum + a.value, 0);
                const totalLiabilities = data.debts.reduce((sum, d) => sum + d.balance, 0);
                const runway = avgMonthlySpend > 0 ? ((totalAssets - totalLiabilities) / avgMonthlySpend).toFixed(1) : "0.0";

                return (
                    <div className="space-y-8">
                        <div className="bg-white p-4 rounded-xl shadow-sm flex flex-col md:flex-row gap-4 items-center justify-between">
                            <div className="flex items-center gap-2 font-bold text-slate-700">
                                <Icons.Filter/> <span>Analytics Filter:</span>
                            </div>
                            <div className="flex gap-4">
                                <select className="border p-2 rounded bg-gray-50 font-bold text-sm" value={analyticsYear} onChange={e => { setAnalyticsYear(e.target.value); setAnalyticsMonth('Whole Year'); }}>
                                    <option value="All Time">All Time</option>
                                    {availableYears.map(y => <option key={y} value={y}>{y}</option>)}
                                </select>
                                <select className="border p-2 rounded bg-gray-50 font-bold text-sm" value={analyticsMonth} onChange={e => setAnalyticsMonth(e.target.value)} disabled={analyticsYear === 'All Time'}>
                                    <option value="Whole Year">Whole Year</option>
                                    {MONTHS.map(m => <option key={m} value={m}>{m}</option>)}
                                </select>
                            </div>
                        </div>

                        <SummaryBlock stats={totalStats} title={`${analyticsYear} - ${analyticsMonth} Summary`} />
                        
                        <div className="bg-slate-800 rounded-xl p-6 grid grid-cols-2 md:grid-cols-4 gap-6 text-center text-white">
                            <div><p className="text-xs text-slate-400 uppercase">Avg Monthly Spend</p><p className="text-xl font-bold text-orange-400">${avgMonthlySpend.toLocaleString(undefined, {maximumFractionDigits:0})}</p></div>
                            <div><p className="text-xs text-slate-400 uppercase">Debt-to-Income</p><p className="text-xl font-bold text-red-400">{dti}%</p></div>
                            <div><p className="text-xs text-slate-400 uppercase">Total Debt Paid</p><p className="text-xl font-bold text-green-400">${totalStats.debtPaid.toLocaleString(undefined, {maximumFractionDigits:0})}</p></div>
                            <div><p className="text-xs text-slate-400 uppercase">Financial Runway</p><p className="text-xl font-bold text-blue-400">{runway} Months</p></div>
                        </div>

                        <div className="grid lg:grid-cols-2 gap-8">
                            <div className="bg-white p-6 rounded-xl shadow-sm">
                                <h3 className="font-bold mb-6 text-gray-700 border-b pb-2 flex gap-2 items-center"><Icons.Chart/> Spending Breakdown (By Group)</h3>
                                {chartSegments.length === 0 ? <p className="text-gray-400 italic text-center py-8">No data available for this period.</p> : (
                                    <div className="flex flex-col md:flex-row items-center gap-8">
                                        <div className="relative w-48 h-48 flex-shrink-0">
                                            <svg viewBox="0 0 100 100" className="w-full h-full transform -rotate-90">
                                                {chartSegments.map((seg, i) => (
                                                    <circle key={i} cx="50" cy="50" r="40" fill="none" stroke={seg.color} strokeWidth="20"
                                                        strokeDasharray={`${(seg.percent / 100) * 251.2} 251.2`}
                                                        strokeDashoffset={-((seg.start / 100) * 251.2)}
                                                        className="chart-segment" />
                                                ))}
                                            </svg>
                                            <div className="absolute inset-0 flex items-center justify-center flex-col">
                                                <span className="text-xs text-gray-400">Total</span>
                                                <span className="font-bold text-gray-800">${totalBreakdownSpend.toLocaleString(undefined, {maximumFractionDigits:0})}</span>
                                            </div>
                                        </div>
                                        <div className="flex-grow w-full">
                                            <div className="space-y-2">
                                                {chartSegments.map((seg, i) => (
                                                    <div key={i} className="flex justify-between text-xs items-center">
                                                        <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full" style={{background: seg.color}}></div><span>{seg[0]}</span></div>
                                                        <span className="font-mono font-bold text-gray-600">${seg[1].toLocaleString()}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                            <div className="bg-white p-6 rounded-xl shadow-sm">
                                <h3 className="font-bold mb-4 text-gray-600">Income Breakdown</h3>
                                <div className="h-6 bg-gray-100 rounded-full overflow-hidden flex border border-gray-200">
                                    <div className="h-full bg-red-400" style={{width: `${spentPct}%`}}></div>
                                    <div className="h-full bg-purple-400" style={{width: `${savedPct}%`}}></div>
                                    <div className="h-full bg-green-400" style={{width: `${remainPct}%`}}></div>
                                </div>
                                <div className="flex justify-between text-xs mt-2 text-gray-500 font-bold">
                                    <span>Spent ({spentPct.toFixed(0)}%)</span>
                                    <span>Saved ({savedPct.toFixed(0)}%)</span>
                                    <span>Left ({remainPct.toFixed(0)}%)</span>
                                </div>
                                 <div className="mt-8 pt-6 border-t border-gray-100">
                                    <h3 className="font-bold mb-4 text-gray-600">Net Worth</h3>
                                    <div className="text-4xl font-bold text-blue-600">${(totalAssets - totalLiabilities).toLocaleString()}</div>
                                    <p className="text-sm text-gray-400">Assets - Liabilities</p>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderStrategy = () => {
                const sortedDebts = [...data.debts].sort((a,b) => a.balance - b.balance);
                let simMonths = 0;
                let tempDebts = sortedDebts.map(d => ({...d}));
                
                while(tempDebts.some(d => d.balance > 0) && simMonths < 360) {
                    simMonths++;
                    let monthlyExtra = parseFloat(debtSimExtra) || 0;
                    tempDebts.forEach(d => {
                        if(d.balance > 0) {
                            const interest = (d.balance * (d.rate/100)) / 12;
                            d.balance += interest;
                            let minPay = Math.max(d.balance * 0.02, 25);
                            if(d.balance < minPay) minPay = d.balance;
                            d.balance -= minPay;
                        }
                    });
                    let target = tempDebts.find(d => d.balance > 0);
                    if(target) target.balance -= monthlyExtra;
                }

                return (
                    <div className="grid md:grid-cols-2 gap-8">
                        <div className="bg-white p-6 rounded-xl shadow-sm">
                            <h2 className="text-xl font-bold text-slate-800 mb-4 border-b pb-2">Debt Payoff Simulator</h2>
                            <div className="mb-6">
                                <label className="block text-sm font-bold text-gray-700 mb-1">Extra Monthly Payment:</label>
                                <input type="number" className="border-2 border-blue-200 rounded px-3 py-2 w-full font-bold text-lg" value={debtSimExtra} onChange={e=>setDebtSimExtra(e.target.value)} />
                            </div>
                            <div className="bg-blue-50 p-4 rounded-lg text-center">
                                <p className="text-blue-900 text-sm font-bold uppercase">Debt Free In</p>
                                <p className="text-3xl font-bold text-blue-600 my-1">{simMonths} Months</p>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-sm">
                            <h2 className="text-xl font-bold text-slate-800 mb-4 border-b pb-2">Savings Goals Buckets</h2>
                            <div className="space-y-4 mb-6">
                                {data.savingsGoals.map(g => {
                                    const pct = Math.min((g.saved / g.target) * 100, 100);
                                    return (
                                        <div key={g.id}>
                                            <div className="flex justify-between text-sm mb-1 font-bold text-gray-700">
                                                <span>{g.label}</span>
                                                <span>${g.saved} / ${g.target}</span>
                                            </div>
                                            <div className="h-3 bg-gray-200 rounded-full overflow-hidden">
                                                <div className="h-full bg-purple-500 progress-bar" style={{width: `${pct}%`}}></div>
                                            </div>
                                            <div className="flex justify-end mt-1">
                                                <button onClick={()=>{
                                                    const amt = parseFloat(prompt("Add amount:"));
                                                    if(amt) setData(d => ({...d, savingsGoals: d.savingsGoals.map(x=>x.id===g.id ? {...x, saved: x.saved+amt} : x)}));
                                                }} className="text-xs text-blue-500 hover:underline mr-2">+ Add Cash</button>
                                                <button onClick={()=>setData(d => ({...d, savingsGoals: d.savingsGoals.filter(x=>x.id!==g.id)}))} className="text-xs text-red-400 hover:underline">Remove</button>
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                            <div className="flex gap-2 items-end bg-gray-50 p-3 rounded">
                                <div className="flex-grow"><label className="text-xs font-bold text-gray-400">Goal</label><input className="w-full border p-1 rounded" value={inputs.goalName} onChange={e=>setInputs({...inputs, goalName:e.target.value})}/></div>
                                <div className="w-24"><label className="text-xs font-bold text-gray-400">Target</label><input type="number" className="w-full border p-1 rounded" value={inputs.goalTarget} onChange={e=>setInputs({...inputs, goalTarget:e.target.value})}/></div>
                                <button onClick={()=>{
                                    if(inputs.goalName && inputs.goalTarget) {
                                        setData(d => ({...d, savingsGoals: [...d.savingsGoals, {id: Date.now(), label: inputs.goalName, target: parseFloat(inputs.goalTarget), saved: 0}]}));
                                        setInputs({...inputs, goalName:'', goalTarget:''});
                                    }
                                }} className="bg-purple-600 text-white p-2 rounded"><Icons.Plus/></button>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="max-w-7xl mx-auto p-4 pb-20">
                    <div className="flex flex-col md:flex-row justify-between items-center mb-6">
                        <div className="flex items-center gap-3">
                            <h1 className="text-3xl font-extrabold text-slate-800 tracking-tight">Financial OS <span className="text-sm font-normal text-slate-400 ml-2">v17</span></h1>
                            {user && <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">{user.displayName}</span>}
                        </div>
                        <div className="flex gap-2 mt-4 md:mt-0">
                            {user && <button onClick={logout} className="bg-white border text-red-500 px-3 py-1.5 rounded text-sm flex gap-2 hover:bg-gray-50"><Icons.LogOut/> Sign Out</button>}
                        </div>
                    </div>

                    <div className="flex gap-1 bg-white p-1 rounded-lg shadow-sm mb-6 overflow-x-auto">
                        {['budget', 'net worth', 'analytics', 'strategy'].map(t => (
                            <button key={t} onClick={()=>setActiveTab(t)} 
                                className={`px-4 py-2 rounded-md font-bold text-sm capitalize whitespace-nowrap transition-colors ${activeTab===t ? 'bg-slate-800 text-white' : 'text-gray-500 hover:bg-gray-100'}`}>
                                {t}
                            </button>
                        ))}
                    </div>

                    <div className="min-h-screen">
                        {activeTab === 'budget' && renderBudget()}
                        {activeTab === 'net worth' && renderNetWorth()}
                        {activeTab === 'analytics' && renderAnalytics()}
                        {activeTab === 'strategy' && renderStrategy()}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FinancialOS />);
    </script>
</body>
</html>
